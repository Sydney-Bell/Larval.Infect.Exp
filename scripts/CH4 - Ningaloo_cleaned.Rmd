---
title: "R Notebook"
output: html_notebook
---

Load necessary packages and functions

```{r}
library('ggplot2'); packageVersion('ggplot2') #version 3.5.0
library(dplyr)
library(tidyr)
library(stats)
library(nlme)
library(glmmTMB)
library(DHARMa)
library(MCMCglmm)
library(coda)
library(parallel)
library(emmeans)
install.packages("tidybayes")
library(tidybayes)

```

Load in Ningaloo metadata and restructure

```{r}
#install.packages("MCMCglmm")
library(MCMCglmm)
#install.packages("lsmeans")
library(emmeans)

totaldf = read.csv("C:/Users/jc980786/OneDrive - James Cook University/Australia/Ningaloo Spawning 2024/Larval Infection Experiment/Metadata_NingSpawn2024_FINAL2.csv", header = TRUE)
str(totaldf)

library(tidyr)

# Convert No.Cells1 to numeric
totaldf$No.Cells1 <- as.numeric(totaldf$No.Cells1)

# Reshape the data to long format so all of the cell densities are in one column
totaldf_long <- totaldf %>%
  pivot_longer(cols = c(No.Cells1, No.Cells2, No.Cells3), 
               names_to = "Cell_Measurement", 
               values_to = "Cell_Density")

# Check the structure of the reshaped data
str(totaldf_long)

# Replace empty strings with NA
totaldf_long$Cell_Density[totaldf_long$Cell_Density == ""] <- NA

# Convert the Cell_Density column to numeric 
totaldf_long$Cell_Density <- as.numeric(totaldf_long$Cell_Density)

# Check for missing values in each of the predictor columns
sum(is.na(totaldf_long$SymbiontTreatment))
sum(is.na(totaldf_long$Family))
sum(is.na(totaldf_long$Treatment))
sum(is.na(totaldf_long$Timepoint))  

# Keep rows up to 8316. After that they are just blank rows that got imported.
totaldf_long_subset <- totaldf_long[1:8316, ]

# Check the structure of the subset data frame
str(totaldf_long_subset)

totaldf_long_clean <- totaldf_long_subset %>%
  filter(!is.na(totaldf_long_subset$SymbiontTreatment) & !is.na(totaldf_long_subset$Family) & !is.na(totaldf_long_subset$Treatment) & !is.na(totaldf_long_subset$Timepoint))

# df is the main dataframe we'll be using
df <- totaldf_long_clean

# Assign Temp values based on Treatment
df_clean <- df %>%
  mutate(Temp = case_when(
    Treatment == "Ambient" ~ "T1",
    Treatment == "31" ~ "T2",
    Treatment == "35.5" ~ "T3",
    TRUE ~ NA_character_  # Handle other cases explicitly
  ))

# Create a UniqueID column by combining Temp and tube.ID columns
df_clean$UniqueID <- paste0(df_clean$Temp, "V", df_clean$tube.ID.1)

```

Fv/Fm - percentage of larvae with symbiont cells

```{r}
ipam <- read.csv("C:/Users/jc980786/OneDrive - James Cook University/Australia/Ningaloo Spawning 2024/Larval Infection Experiment/Metadata_NingSpawn2024_iPAM.csv")
str(ipam)

library(dplyr)
library(tidyr)
library(stringr)
library(lubridate)

ipam <- ipam %>%
  # Assign treatment labels
  mutate(TREATMENT = case_when(
    TEMP == 27.5 ~ "T1",
    TEMP == 31 ~ "T2",
    TEMP == 35.5 ~ "T3",
    TRUE ~ NA_character_
  )) %>%
  # Create UniqueID
  mutate(UniqueID = paste0(TREATMENT, "V", VIAL)) %>%
  # Add missing REP rows per UniqueID × TIMEPOINT
  group_by(UniqueID, TIMEPOINT) %>%
  complete(REP = 1:5, fill = list(FvFm = 0)) %>%
  # Fill metadata values downward and upward within group
  fill(TEMP, SYMBIONT_TREATMENT, .direction = "downup") %>%
  ungroup() %>%
  # Recalculate VIAL from UniqueID if still missing
  mutate(
    VIAL = ifelse(is.na(VIAL), as.integer(str_extract(UniqueID, "(?<=V)\\d+")), VIAL),
    TREATMENT = ifelse(is.na(TREATMENT), str_extract(UniqueID, "^T\\d"), TREATMENT)
  ) %>%
  # Add Dates for TIMEPOINTs
  mutate(
    Days = case_when(
      TIMEPOINT == 1 ~ as.Date("2024-04-11"),
      TIMEPOINT == 4 ~ as.Date("2024-04-14"),
      TIMEPOINT == 22 ~ as.Date("2024-05-02"),
      TRUE ~ as.Date(NA)
    )
  )

# Load metadata summary
perc_larvae_summary <- read.csv("C:/Users/jc980786/OneDrive - James Cook University/Australia/Ningaloo Spawning 2024/Larval Infection Experiment/perc_larvae_summary.csv")

# Make sure TIMEPOINT is the same type in both dataframes (numeric or integer)
perc_larvae_summary <- perc_larvae_summary %>%
  rename(TIMEPOINT = Days) %>%
  rename(UniqueID = rep.ID)
perc_larvae_summary$TIMEPOINT <- as.numeric(perc_larvae_summary$TIMEPOINT)
ipam$TIMEPOINT <- as.numeric(ipam$TIMEPOINT)

# Merge metadata
ipam <- ipam %>%
  left_join(perc_larvae_summary, by = c("UniqueID", "TIMEPOINT"))

#Clean up
ipam <- ipam %>%
  dplyr::select(-POINT, -SYMBIONT_TREATMENT, -PAR, -AVERAGE_FvFm)

#Calculate the percentage of larvae with cells per vial:
epsilon <- 1e-8  # Avoid division by zero

ipam <- ipam %>%
  group_by(UniqueID) %>%
  arrange(TIMEPOINT) %>%
  mutate(
    CellsInitial = first(na.omit(perc.larv)),
    CellsFinal = last(na.omit(perc.larv)),
    PercChangeCells = ((CellsFinal - CellsInitial))
  ) %>%
  ungroup()

#Calculate the percentage of larvae with cells per vial for summary plot. Assuming that FvFm > 0 indicates larvae with cells:
summary_df <- ipam %>%
  group_by(TIMEPOINT, TREATMENT) %>%
  summarize(PercentageWithCells = mean(FvFm > 0, na.rm = TRUE) * 100)

#create figure
ggplot(ipam, aes(x = TIMEPOINT, y = PercChangeCells, color = TREATMENT)) +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  labs(
    title = "Percentage of Larvae with Cells Over Time",
    x = "Days",
    y = "Percentage of Larvae with Cells"
  ) +
  theme_minimal() +
  theme(
    text = element_text(size = 14),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10)
  ) +
  scale_color_manual(values = c("T1" = "blue", "T2" = "orange", "T3" = "red"))

#Now we want to view differences in symbiont taxa
# Subset totaldf_long to UniqueID and SymbiontTreatment and remove duplicates
df_clean_subset <- df_clean %>%
  dplyr::select(UniqueID, SymbiontTreatment, ReefMom) %>%
  distinct(UniqueID, .keep_all = TRUE)

# Merge the SymbiontTreatment column from totaldf_long to ipam by UniqueID
ipam_taxa <- ipam %>%
  left_join(df_clean_subset %>% dplyr::select(UniqueID, SymbiontTreatment), by = "UniqueID")

# Summarize data to include SymbiontTreatment
ipam_taxa <- ipam_taxa %>%
  rename(SymbiontTreatment = zoox)

summary_df2 <- ipam_taxa %>%
  group_by(Timepoint, Treatment, SymbiontTreatment) %>%
  summarize(PercentageWithCells = mean(FvFm > 0, na.rm = TRUE) * 100, .groups = "drop")

# Define custom colors for SymbiontTreatment
custom_colors <- c("C" = "green", "D" = "red")  # Example: red-orange for "C" and blue for "D"

#make timepoint numeric
summary_df2$Timepoint <- as.numeric(as.character(summary_df2$Timepoint))

#plot
ggplot(summary_df2, aes(x = Timepoint, y = PercentageWithCells, color = SymbiontTreatment)) +
  geom_point(alpha = 0.6, size = 2) +  # Scatter plot
  geom_line(aes(group = SymbiontTreatment), alpha = 0.6) +  # Line connecting points
  facet_wrap(~ Treatment, scales = "fixed") +  # Facets by TREATMENT with free y-axes
  scale_color_manual(values = custom_colors) +  # Apply custom colors
  scale_x_continuous(
    breaks = c(0,2,4,6,8,10,12,14,16,18,20,22),  # Add breaks for specific days
    labels = c("0","2","4","6","8","10","12","14","16","18","20","22")  # Label days
  ) +
  labs(
    title = "Percentage of Larvae with Cells Over Time",
    x = "Days",
    y = "Percentage with Cells (%)",
    color = "Symbiont Treatment"
  ) +
  theme_classic() +  # Clean theme
  theme(
    strip.text = element_text(size = 12),  # Facet label size
    axis.text = element_text(size = 10),  # Axis text size
    legend.title = element_text(size = 12),  # Legend title size
    legend.text = element_text(size = 10)   # Legend text size
  )

#Plot only survivors
#gives basically the same output as the original
# Step 1: Identify UniqueIDs present in all three timepoints (1, 4, 22)
filtered_ipam <- ipam %>%
  filter(Timepoint %in% c(1, 4, 22))

# Step 3: Merge SymbiontTreatment for surviving larvae
filtered_ipam <- filtered_ipam %>%
  left_join(df_clean_subset %>% dplyr::select(UniqueID, SymbiontTreatment, ReefMom), by = "UniqueID")

# Step 4: Create the summary dataframe for larvae that survived until timepoint 22
filtered_ipam <- filtered_ipam %>%
  rename(SymbiontTreatment = zoox)

ipam_taxa_survived <- filtered_ipam %>%
  group_by(Timepoint, Treatment, ReefMom, SymbiontTreatment, UniqueID) %>%
  summarize(PercentageWithCells = mean(FvFm > 0, na.rm = TRUE) * 100, .groups = "drop")

# Step 6: Map days to numeric day values
summary_df2_survived <- ipam_taxa_survived %>%
  mutate(DayNumber = as.numeric(date_to_day[as.character(Timepoint)]))

# Step 7: Plot the data for only larvae that survived until timepoint 22 and have data for all three timepoints
summary_df2_survived$Timepoint <- as.numeric(as.character(summary_df2_survived$Timepoint))

ggplot(summary_df2_survived, aes(x = Timepoint, y = PercentageWithCells,
                               color = ReefMom, shape = SymbiontTreatment)) +
  geom_point(alpha = 0.6, size = 2) +  # Scatter plot
  geom_line(aes(group = interaction(ReefMom, SymbiontTreatment)), alpha = 0.6) +  # Line connecting points
  facet_wrap(~ Treatment) +  # Facets by TREATMENT
  scale_color_manual(values = custom_ReefMom_colors) +  # Apply custom colors
  scale_x_continuous(
    breaks = c(0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22),
    labels = c("0", "2", "4", "6", "8", "10", "12", "14", "16", "18", "20", "22")
  ) +
  labs(
    title = "Percentage of Larvae with Cells Over Time",
    x = "Days",
    y = "Percentage with Cells (%)",
    color = "ReefMom",
    shape = "Symbiont Treatment"
  ) +
  theme_classic() +
  theme(
    strip.text = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10)
  )


#plot with summary stats for Cross
# Add Cross column based on ReefMom
ipam_taxa_survived <- ipam_taxa_survived %>%
  mutate(Cross = case_when(
    ReefMom %in% c("BT2", "BT4", "BT8") ~ "CC",
    TRUE ~ "WW"
  ))

# Then summarize including Cross instead of ReefMom
summary_stats <- ipam_taxa_survived %>%
  group_by(Timepoint, SymbiontTreatment, Treatment, Cross) %>%
  summarise(
    mean_pct = mean(PercentageWithCells, na.rm = TRUE),
    se = sd(PercentageWithCells, na.rm = TRUE) / sqrt(sum(!is.na(PercentageWithCells))),
    ci_lower = mean_pct - qt(0.975, df = sum(!is.na(PercentageWithCells)) - 1) * se,
    ci_upper = mean_pct + qt(0.975, df = sum(!is.na(PercentageWithCells)) - 1) * se,
    .groups = "drop"
  )


plot1_perc <- ggplot(summary_stats, aes(x = Timepoint, y = mean_pct, color = Cross, shape = SymbiontTreatment)) +
  geom_point(size = 3) +
  geom_line(aes(group = SymbiontTreatment), size = 1) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper, group = SymbiontTreatment), width = 0.3) +
  facet_grid(Cross ~ Treatment) +
  scale_color_manual(values = c("CC" = "#1f77b4", "WW" = "#ff7f0e")) +
  labs(
    title = "Percentage of Larvae with Cells Over Time",
    x = "Days",
    y = "Mean Percentage with Cells (%)",
    color = "Population of Origin"
  ) +
  theme_classic()


```

Combine PercentageWithCells and Cell Density
```{r}
# Load patchwork library
library(patchwork)

# Second plot: Cell Density
summary_df_cells <- summary_df_cells %>%
  mutate(Reef = if_else(Cross %in% c("B.T.2xB.T.4", "B.T.4xB.T.2", "B.T.8xB.T.2"), "CC", "WW"))

# Step 1: average within UniqueID first
uniqueID_summary <- summary_df_cells %>%
  group_by(DayNumber, Reef, CellType, Treatment, TubeID) %>%
  summarise(
    mean_CellDensity_perID = mean(CellDensity, na.rm = TRUE),
    .groups = "drop"
  )

# Step 2: summarize across UniqueIDs to get overall group summary stats
summary_df_cells_grouped <- uniqueID_summary %>%
  group_by(DayNumber, Reef, CellType, Treatment) %>%
  summarise(
    mean_CellDensity = mean(mean_CellDensity_perID, na.rm = TRUE),
    sd_CellDensity = sd(mean_CellDensity_perID, na.rm = TRUE),
    n = n(),  # number of unique UniqueIDs
    se = sd_CellDensity / sqrt(n),
    ci_lower = mean_CellDensity - qt(0.975, df = n - 1) * se,
    ci_upper = mean_CellDensity + qt(0.975, df = n - 1) * se,
    .groups = "drop"
  )


custom_Reef_colors <- c("CC" = "blue", "WW" = "red")  # Adjust as needed

plot2 <- ggplot(summary_df_cells_grouped, aes(x = DayNumber, y = mean_CellDensity, color = Reef, shape = CellType)) +
  geom_point(alpha = 0.8, size = 3) +
  geom_line(aes(group = interaction(Reef, CellType)), alpha = 0.6) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper, group = interaction(Reef, CellType)), width = 0.3, alpha = 0.7) +
  facet_grid(Reef ~ Treatment) +
  scale_color_manual(values = custom_Reef_colors) +
  scale_x_continuous(
    breaks = seq(0, 22, by = 2),
    labels = as.character(seq(0, 22, by = 2))
  ) +
  labs(
    title = "Cell Density by Timepoint for Each Cross",
    x = "Days",
    y = "Mean Cell Density",
    color = "Cross",
    shape = "Cell Type"
  ) +
  theme_classic() +
  theme(
    strip.text = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10)
  )

summary_df_cells_grouped %>%
  group_by(DayNumber, Reef, CellType, Treatment) %>%
  tally()




# Combine plots using patchwork
combined_plot <- plot1_perc / plot2  # Stack vertically
# Alternatively, to place them side by side:
# combined_plot <- plot1 + plot2

# Display combined plot
combined_plot

# Save the combined plot
ggsave("C:/Users/jc980786/OneDrive - James Cook University/Australia/Ningaloo Spawning 2024/Larval Infection Experiment/combined_plot_percentcells_density_by_Reef.png", plot = combined_plot, width = 10, height = 8, dpi = 300)


```

Plot of mean size at T22

```{r}
# Replace NA values with zeros in the Area..mm.2. column
df_clean$Area..mm.2.[is.na(df_clean$Area..mm.2.)] <- 0

# Group by UniqueID and calculate initial and final cell densities
df_clean <- df_clean %>%
  group_by(UniqueID) %>%
  arrange(Timepoint) %>%  # Ensure the dataframe is arranged by Timepoint
  mutate(
    Sizeinitial = first(Area..mm.2.),  # First recorded value of size for each UniqueID
    Sizefinal = last(Area..mm.2.)      # Last recorded value of size for each UniqueID
  ) %>%
  ungroup()

# Filter the dataframe to get data for the final timepoint (22)
final_timepoint_df <- df_clean %>%
  filter(Timepoint == 22) %>%
  group_by(Treatment, Cross_2, SymbiontTreatment) %>%
  summarise(mean_area = mean(Area..mm.2., na.rm = TRUE),
            se_area = sd(Area..mm.2., na.rm = TRUE) / sqrt(n()))

all_combos <- expand.grid(
  Treatment = c("Ambient", "31", "35.5"),
  Cross_2 = unique(df_clean$Cross_2),
  SymbiontTreatment = unique(df_clean$SymbiontTreatment),
  stringsAsFactors = FALSE
)

final_timepoint_df_full <- all_combos %>%
  left_join(final_timepoint_df, by = c("Treatment", "Cross_2", "SymbiontTreatment")) %>%
  mutate(
    mean_area = ifelse(is.na(mean_area), 0, mean_area),
    se_area = ifelse(is.na(se_area), 0, se_area),
    Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5"))  # Re-set factor levels
  )

# Define a custom color palette
custom_colors <- c("CC" = "#1f77b4", "WW" = "#ff7f0e") # Modify colors as needed

# Plot the mean area with error bars and custom colors
area_plot <- ggplot(final_timepoint_df, aes(x = Treatment, y = mean_area)) +
  geom_point(aes(fill = Cross_2, shape = SymbiontTreatment), 
             color = "black", size = 4, stroke = 1.5) +  # black border around points
  geom_errorbar(aes(ymin = mean_area - se_area, ymax = mean_area + se_area, 
                    color = Cross_2), 
                width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  scale_fill_manual(values = custom_colors) +
  scale_color_manual(values = custom_colors) +
  scale_shape_manual(values = c(21, 24)) +  # use shapes that support fill (adjust as needed)
  labs(x = "Temperature Treatment", y = "Mean Area (mm² ± s.e.)",
       title = "Mean Larval Area at Final Timepoint (22)") +
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black")
  )



# Display the plot
print(area_plot)

# Create inset for the above plot
# Step 1: Filter the dataframe to get data for the final timepoint (22)
final_timepoint_df_inset <- df_clean %>%
  filter(Timepoint == 22) %>%
  group_by(Treatment) %>%
  summarise(mean_area = mean(Area..mm.2., na.rm = TRUE),
            se_area = sd(Area..mm.2., na.rm = TRUE) / sqrt(n()))

# Reorder the Treatment factor in the desired order
final_timepoint_df_inset <- final_timepoint_df_inset %>%
  mutate(Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5")))

# Step 2: Create the plot
mean_area_plot <- ggplot(final_timepoint_df_inset, aes(x = Treatment, y = mean_area)) +
  geom_point(size = 4, shape = 1, fill = NA, stroke = 1.5) +  # Adjust point size as needed
  geom_errorbar(aes(ymin = mean_area - se_area, ymax = mean_area + se_area), 
                width = 0.2) +
  labs(x = "Temperature (Treatment)", y = "Mean Area (mm² ± s.e.)",
       title = "Mean Larval Area at Final Timepoint (All Crosses and Symbiont Treatments)") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),  # Remove major grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    axis.line = element_line(color = "black", linewidth = 0.5)  # Keep axis lines
  )

# Step 4: Display the plot
print(mean_area_plot)

# Create inset for the above plot seperated by Treatment and Symbiont treatment
# Step 1: Filter the dataframe to get data for the final timepoint (22)
final_timepoint_df_inset2 <- df_clean %>%
  filter(Timepoint == 22) %>%
  group_by(Treatment, SymbiontTreatment) %>%
  summarise(mean_area = mean(Area..mm.2., na.rm = TRUE),
            se_area = sd(Area..mm.2., na.rm = TRUE) / sqrt(n()))

# Reorder the Treatment factor in the desired order
final_timepoint_df_inset2 <- final_timepoint_df_inset2 %>%
  mutate(Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5")))

# Step 2: Create the plot
mean_area_plot2 <- ggplot(final_timepoint_df_inset2, aes(x = Treatment, y = mean_area, shape = SymbiontTreatment)) +
  geom_point(size = 4, fill = NA, stroke = 1.5) +  # Adjust point size as needed
  geom_errorbar(aes(ymin = mean_area - se_area, ymax = mean_area + se_area), 
                width = 0.2) +
  labs(x = "Temperature (Treatment)", y = "Mean Area (mm² ± s.e.)",
       title = "Mean Larval Area at Final Timepoint (All Crosses and Symbiont Treatments)") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),  # Remove major grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    axis.line = element_line(color = "black", linewidth = 0.5)  # Keep axis lines
  )

# Step 4: Display the plot
print(mean_area_plot2)

# Combine the two plots side by side
combined_plot_mean_area <- mean_area_plot + mean_area_plot2 + plot_layout(ncol = 2)

# Display the combined plot
print(combined_plot_mean_area)

# Save the combined plot as a PNG file
ggsave("combined_plot_mean_area_inset.png", plot = combined_plot_mean_area, width = 6, height = 3, dpi = 300)

```

Plot of percent change in size

```{r}

# Group by Treatment, Cross_2, and SymbiontTreatment, and calculate mean and standard error for percent change
perc_change_summary <- totaldf_long %>%
  filter(Timepoint == 22, Status == 0) %>%
  group_by(Treatment, Cross_2, SymbiontTreatment) %>%
  summarise(mean_perc_change = mean(PercChangeSize, na.rm = TRUE),
            se_perc_change = sd(PercChangeSize, na.rm = TRUE) / sqrt(n()))

all_combos <- expand.grid(
  Treatment = c("Ambient", "31", "35.5"),
  Cross_2 = unique(totaldf_long$Cross_2),
  SymbiontTreatment = unique(totaldf_long$SymbiontTreatment),
  stringsAsFactors = FALSE
)

perc_change_summary <- all_combos %>%
  left_join(perc_change_summary, by = c("Treatment", "Cross_2", "SymbiontTreatment")) %>%
  mutate(
    mean_area = ifelse(is.na(mean_perc_change), 0, mean_perc_change),
    se_area = ifelse(is.na(se_perc_change), 0, se_perc_change),
    Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5"))  # Re-set factor levels
  )

# Define a custom color palette (same as before)
custom_colors <- c("CC" = "#1f77b4", "WW" = "#ff7f0e")  # Modify colors as needed

# Plot the percent change in area with error bars and custom colors
perc_change_plot <- ggplot(perc_change_summary, aes(x = Treatment, y = mean_perc_change, 
                                                    fill = Cross_2, shape = SymbiontTreatment)) +
  geom_point(size = 4, color = "black", stroke = 1.5) +  # Point border is black
  geom_errorbar(aes(ymin = mean_perc_change - se_perc_change,
                    ymax = mean_perc_change + se_perc_change,
                    color = Cross_2),  # Match error bars to fill color
                width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  scale_fill_manual(values = custom_colors) +   # Fill = group color
  scale_color_manual(values = custom_colors) +  # Color = same as fill (for error bars)
  scale_shape_manual(values = c(21, 24)) +      # Shapes that allow fill and border
  labs(x = "Temperature (Treatment)", y = "Percent Change in Area (± s.e.)",
       title = "Percent Change in Larval Area from Timepoint 1 to 22") +
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black")
  )


# Display the plot
print(perc_change_plot)

# Create inset just for treatment
# Group by Treatment and calculate mean and standard error for percent change
perc_change_summary2 <- df_clean %>%
  group_by(Treatment) %>%
  summarise(mean_perc_change = mean(PercChangeArea, na.rm = TRUE),
            se_perc_change = sd(PercChangeArea, na.rm = TRUE) / sqrt(n()))

# Reorder the Treatment factor in the desired order
perc_change_summary2 <- perc_change_summary2 %>%
  mutate(Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5")))

# Plot the percent change in area with error bars and custom colors
perc_change_plot2 <- ggplot(perc_change_summary2, aes(x = Treatment, y = mean_perc_change)) +
  geom_point(size = 4, shape = 1, stroke = 1.5) +
  geom_errorbar(aes(ymin = mean_perc_change - se_perc_change, ymax = mean_perc_change + se_perc_change), 
                width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  # Add dashed line at y = 0
  labs(x = "Temperature (Treatment)", y = "Percent Change in Area (mm² ± s.e.)",
       title = "Percent Change in Larval Area from Timepoint 1 to 22") +
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),  # Remove major grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    axis.line = element_line(color = "black"),  # Keep x and y axis lines
    axis.ticks = element_line(color = "black")  # Add axis ticks
  )

# Display the plot
print(perc_change_plot2)

# Create inset for treatment and symbiont treatment
# Group by Treatment and SymbiontTreatment, and calculate mean and standard error for percent change
perc_change_summary3 <- df_clean %>%
  group_by(Treatment, SymbiontTreatment) %>%
  summarise(mean_perc_change = mean(PercChangeArea, na.rm = TRUE),
            se_perc_change = sd(PercChangeArea, na.rm = TRUE) / sqrt(n()))

# Reorder the Treatment factor in the desired order
perc_change_summary3 <- perc_change_summary3 %>%
  mutate(Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5")))

# Plot the percent change in area with error bars and custom colors
perc_change_plot3 <- ggplot(perc_change_summary3, aes(x = Treatment, y = mean_perc_change, shape = SymbiontTreatment)) +
  geom_point(size = 4, stroke = 1.5) +
  geom_errorbar(aes(ymin = mean_perc_change - se_perc_change, ymax = mean_perc_change + se_perc_change), 
                width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  # Add dashed line at y = 0
  labs(x = "Temperature (Treatment)", y = "Percent Change in Area (mm² ± s.e.)",
       title = "Percent Change in Larval Area from Timepoint 1 to 22") +
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),  # Remove major grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    axis.line = element_line(color = "black"),  # Keep x and y axis lines
    axis.ticks = element_line(color = "black")  # Add axis ticks
  )

# Display the plot
print(perc_change_plot3)

# Combine the two plots side by side
combined_plot_perc_area <- perc_change_plot2 + perc_change_plot3 + plot_layout(ncol = 2)

# Display the combined plot
print(combined_plot_perc_area)

# Save the combined plot as a PNG file
ggsave("combined_plot_perc_area_inset.png", plot = combined_plot_perc_area, width = 6, height = 3, dpi = 300)
```
Combine area and perc change area plots
```{r}
# Install patchwork if you haven't already
install.packages("patchwork")

# Load patchwork
library(patchwork)

# Combine the two plots side by side
combined_plot <- area_plot + perc_change_plot + plot_layout(ncol = 2)

# Display the combined plot
print(combined_plot)

# Save the combined plot as a PNG file
ggsave("combined_plot.png", plot = combined_plot, width = 12, height = 6, dpi = 300)

```

Percent change in size for survivors

```{r}
# Group by Treatment, Cross_2, and SymbiontTreatment, and calculate mean and standard error for percent change
perc_change_summary <- totaldf_long %>%
  filter(Timepoint == 22, Status == 0) %>%
  group_by(Treatment, Cross_2, SymbiontTreatment, ReefMom) %>%
  summarise(mean_perc_change = mean(PercChangeSize, na.rm = TRUE),
            se_perc_change = sd(PercChangeSize, na.rm = TRUE) / sqrt(n()))

all_combos <- expand.grid(
  Treatment = c("Ambient", "31"),
  Cross_2 = unique(totaldf_long$Cross_2),
  SymbiontTreatment = unique(totaldf_long$SymbiontTreatment),
  ReefMom = unique (totaldf_long$ReefMom),
  stringsAsFactors = FALSE
)

perc_change_summary <- all_combos %>%
  left_join(perc_change_summary, by = c("Treatment", "Cross_2", "SymbiontTreatment", "ReefMom")) %>%
  mutate(
    mean_area = ifelse(is.na(mean_perc_change), 0, mean_perc_change),
    se_area = ifelse(is.na(se_perc_change), 0, se_perc_change),
    Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5"))  # Re-set factor levels
  )

# Define a custom color palette (same as before)
custom_colors <- c("CC" = "#1f77b4", "WW" = "#ff7f0e")  # Modify colors as needed

# Plot percent change in area with colors assigned to Cross_2 and separate panels for Family
survivors_perc_change <- ggplot(perc_change_summary, aes(x = Treatment, y = mean_perc_change, 
                                                        fill = Cross_2, shape = SymbiontTreatment)) +
  geom_line(aes(group = interaction(Cross_2, SymbiontTreatment), color = Cross_2), size = 0.7) +  # connecting lines
  geom_point(size = 4, color = "black", stroke = 1.5) +  # points with black border
  geom_errorbar(aes(ymin = mean_perc_change - se_perc_change,
                    ymax = mean_perc_change + se_perc_change,
                    color = Cross_2), width = 0.2) +  # error bars matching fill color
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  scale_fill_manual(values = custom_colors) +  # fill for points
  scale_color_manual(values = custom_colors) + # color for error bars and lines
  scale_shape_manual(values = c(21, 24)) + # shapes that support fill + border
  facet_wrap(~ ReefMom, nrow = 7) +
  labs(x = "Temperature (Treatment)", y = "Percent Change in Area (mm² ± s.e.)",
       title = "Percent Change in Larval Area (Survived to Timepoint 22)") +
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.5),
    axis.ticks = element_line(color = "black")
  )


print(survivors_perc_change)

# Save the plot to a file
ggsave("percent_change_area_plot.png", 
       plot = survivors_perc_change,  # Save the most recent plot
       width = 10,          # Set the width of the plot (in inches)
       height = 7,          # Set the height of the plot (in inches)
       dpi = 300)           # Set the resolution (300 dpi is good for publications)  
```

Combine the 3 plots for size into one figure

```{r}
# Combine the three plots into one figure
combined_plot2 <- area_plot +  theme(legend.position = "none") +
  perc_change_plot +  theme(legend.position = "none") +
  survivors_perc_change +  theme(legend.position = "none") +
  plot_layout(ncol = 3)  # Stack them vertically (1 column)

# Display the combined plot
print(combined_plot2)

ggsave("C:/Users/bellb/OneDrive - James Cook University/Australia/Ningaloo Spawning 2024/combined_plot_size.png", 
       plot = combined_plot2,  # Save the most recent plot
       width = 10,          # Set the width of the plot (in inches)
       height = 7,          # Set the height of the plot (in inches)
       dpi = 300)           # Set the resolution (300 dpi is good for publications)  

```

Plot of mean FV/FM at T22
(first measurements taken at T4)

```{r}

# Filter the dataframe to get data for the final timepoint (22)
final_timepoint_fvfm_df <- totaldf_long %>%
  filter(Timepoint == 22) %>%
  group_by(Treatment, Cross_2, SymbiontTreatment) %>%
  summarise(mean_fvfm = mean(FvFm, na.rm = TRUE),
            se_fvfm = sd(FvFm, na.rm = TRUE) / sqrt(n()))

# Reorder the Treatment factor in the desired order
final_timepoint_fvfm_df <- final_timepoint_fvfm_df %>%
  mutate(Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5")))

# Identify all combinations that should be present
all_combos <- expand.grid(
  Treatment = c("Ambient", "31", "35.5"),
  SymbiontTreatment = unique(final_timepoint_fvfm_df$SymbiontTreatment),
  Cross_2 = unique(final_timepoint_fvfm_df$Cross_2)
)

# Join with existing data
final_timepoint_fvfm_df <- all_combos %>%
  left_join(final_timepoint_fvfm_df, by = c("Treatment", "SymbiontTreatment", "Cross_2")) %>%
  mutate(
    Timepoint = 22,
    mean_fvfm = ifelse(is.na(mean_fvfm), 0, mean_fvfm),
    se_fvfm = ifelse(is.na(se_fvfm), 0, se_fvfm)
  )

# Define a custom color palette
custom_colors <- c("BxB" = "#1f77b4", "TxT" = "#ff7f0e") # Modify colors as needed

# Plot the mean area with error bars and custom colors
fvfm_plot <- ggplot(final_timepoint_fvfm_df, aes(x = Treatment, y = mean_fvfm, 
                                                 fill = Cross_2, shape = SymbiontTreatment)) +
  # Error bars match fill color
  geom_errorbar(aes(ymin = mean_fvfm - se_fvfm, ymax = mean_fvfm + se_fvfm,
                    color = Cross_2), 
                width = 0.2) +
  
  # Reference line
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +

  # Points with fill and black border
  geom_point(size = 4, stroke = 1.2, color = "black") +

  # Manual color settings
  scale_fill_manual(values = custom_colors) +
  scale_color_manual(values = custom_colors) +
  scale_shape_manual(values = c("C" = 21, "D" = 24)) +

  # Labels and theme
  labs(x = "Temperature Treatment", 
       y = "Mean Fv/Fm (± s.e.)",
       title = "Mean Larval Fv/Fm at Final Timepoint (22)") +
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black")
  )

fvfm_plot

# Create inset for the above plot
# Step 1: Filter the dataframe to get data for the final timepoint (22)

# Reorder the Treatment factor in the desired order
totaldf_long <- totaldf_long %>%
  mutate(Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5")))

final_timepoint_fvfm_df_inset <- totaldf_long %>%
  filter(Treatment != "35.5") %>% 
  filter(Timepoint == 22) %>%
  group_by(Treatment) %>%
  summarise(mean_fvfm = mean(FvFm, na.rm = TRUE),
            se_fvfm = sd(FvFm, na.rm = TRUE) / sqrt(n()))

# Step 2: Create the plot
mean_fvfm_plot <- ggplot(final_timepoint_fvfm_df_inset, aes(x = Treatment, y = mean_fvfm)) +
  geom_point(size = 4, shape = 1, fill = NA, stroke = 1.5) +  # Adjust point size as needed
  geom_errorbar(aes(ymin = mean_fvfm - se_fvfm, ymax = mean_fvfm + se_fvfm), 
                width = 0.2) +
  labs(x = "Temperature (Treatment)", y = "Mean Fv/Fm (± s.e.)",
       title = "Mean Larval Fv/Fm at Final Timepoint (All Crosses and Symbiont Treatments)") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),  # Remove major grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    axis.line = element_line(color = "black", linewidth = 0.5)  # Keep axis lines
  )

# Step 4: Display the plot
print(mean_fvfm_plot)

# Create inset for the above plot seperated by Treatment and Symbiont treatment
# Step 1: Filter the dataframe to get data for the final timepoint (22)
final_timepoint_fvfm_df_inset2 <- totaldf_long %>%
  filter(Treatment != "35.5") %>%
  filter(Timepoint == 22) %>%
  group_by(Treatment, SymbiontTreatment) %>%
  summarise(mean_fvfm = mean(FvFm, na.rm = TRUE),
            se_fvfm = sd(FvFm, na.rm = TRUE) / sqrt(n()))

# Reorder the Treatment factor in the desired order
totaldf_long <- totaldf_long %>%
  mutate(Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5")))

# Step 2: Create the plot
mean_fvfm_plot2 <- ggplot(final_timepoint_fvfm_df_inset2, aes(x = Treatment, y = mean_fvfm, shape = SymbiontTreatment)) +
  geom_point(size = 4, fill = NA, stroke = 1.5) +  # Adjust point size as needed
  geom_errorbar(aes(ymin = mean_fvfm - se_fvfm, ymax = mean_fvfm + se_fvfm), 
                width = 0.2) +
  labs(x = "Temperature (Treatment)", y = "Mean Fv/Fm (± s.e.)",
       title = "Mean Larval Fv/Fm at Final Timepoint (All Crosses and Symbiont Treatments)") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),  # Remove major grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    axis.line = element_line(color = "black", linewidth = 0.5)  # Keep axis lines
  )

# Step 4: Display the plot
print(mean_fvfm_plot2)

# Combine the two plots side by side
combined_plot_mean_fvfm <- mean_fvfm_plot + mean_fvfm_plot2 + plot_layout(ncol = 2)

# Display the combined plot
print(combined_plot_mean_fvfm)

# Save the combined plot as a PNG file
ggsave("C:/Users/bellb/OneDrive - James Cook University/Australia/Ningaloo Spawning 2024/combined_plot_mean_fvfm_inset.png", plot = combined_plot_mean_fvfm, width = 6, height = 3, dpi = 300)

```


Plot of raw change in Fv/Fm (% change has too large of error margins for survivors GLMM)

```{r}

# Group by Treatment, Cross_2, and SymbiontTreatment, and calculate mean and standard error for percent change
raw_change_fvfm_summary <- totaldf_long %>%
  filter(Timepoint == 22, Status == 0) %>%
  group_by(Treatment, Cross_2, SymbiontTreatment) %>%
  summarise(
    mean_raw_change = mean(RawChangeFvFm, na.rm = TRUE),
    se_raw_change = sd(RawChangeFvFm, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

# Reorder the Treatment factor in the desired order
raw_change_fvfm_summary <- raw_change_fvfm_summary %>%
  mutate(Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5")))

# Identify all combinations that should be present
all_combos <- expand.grid(
  Treatment = c("Ambient", "31", "35.5"),
  SymbiontTreatment = unique(raw_change_fvfm_summary$SymbiontTreatment),
  Cross_2 = unique(raw_change_fvfm_summary$Cross_2)
)

# Join with existing data
raw_change_fvfm_summary <- all_combos %>%
  left_join(raw_change_fvfm_summary, by = c("Treatment", "SymbiontTreatment", "Cross_2")) %>%
  mutate(
    Timepoint = 22,
    raw_pct = ifelse(is.na(mean_raw_change), 0, mean_raw_change),
    se_raw_change = ifelse(is.na(se_raw_change), 0, se_raw_change)
  )

# Define a custom color palette (same as before)
custom_colors <- c("CC" = "#1f77b4", "WW" = "#ff7f0e")  # Modify colors as needed

# Plot the percent change in area with error bars and custom colors
raw_change_fvfm_plot <- ggplot(raw_change_fvfm_summary, aes(
  x = Treatment,
  y = mean_raw_change,
  fill = Cross_2,
  shape = SymbiontTreatment
)) +
  # Error bars colored by Cross_2 (same as fill)
  geom_errorbar(
    aes(
      ymin = mean_raw_change - se_raw_change,
      ymax = mean_raw_change + se_raw_change,
      color = Cross_2
    ),
    width = 0.2
  ) +
  # Points with colored fill and black border
  geom_point(
    size = 4,
    stroke = 1.2,
    color = "black"  # black border
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  scale_fill_manual(values = custom_colors) +   # fill for points
  scale_color_manual(values = custom_colors) +  # color for error bars
  scale_shape_manual(values = c("C" = 21, "D" = 24)) +  # circle and triangle
  labs(
    x = "Temperature (Treatment)",
    y = "Raw Change in Fv/Fm (± s.e.)",
    title = "Raw Change in Larval Fv/Fm from Timepoint 4 to 22"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black")
  )


# Display the plot
print(raw_change_fvfm_plot)

# Create inset just for treatment
# Group by Treatment and calculate mean and standard error for percent change
raw_change_summary2 <- totaldf_long %>%
  filter(Treatment != "35.5") %>% 
  group_by(Treatment) %>%
  summarise(mean_raw_change = mean(RawChangeFvFm, na.rm = TRUE),
            se_raw_change = sd(RawChangeFvFm, na.rm = TRUE) / sqrt(n()))

# Reorder the Treatment factor in the desired order
raw_change_summary2 <- raw_change_summary2 %>%
  mutate(Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5")))

# Plot the percent change in area with error bars and custom colors
raw_change_plot2 <- ggplot(raw_change_summary2, aes(x = Treatment, y = mean_raw_change)) +
  geom_point(size = 4, shape = 1, stroke = 1.5) +
  geom_errorbar(aes(ymin = mean_raw_change - se_raw_change, ymax = mean_raw_change + se_raw_change), 
                width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  # Add dashed line at y = 0
  labs(x = "Temperature (Treatment)", y = "Raw Change in Fv/Fm (± s.e.)",
       title = "Raw Change in Larval Fv/Fm from Timepoint 4 to 22") +
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),  # Remove major grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    axis.line = element_line(color = "black"),  # Keep x and y axis lines
    axis.ticks = element_line(color = "black")  # Add axis ticks
  )

# Display the plot
print(raw_change_plot2)

# Create inset for treatment and symbiont treatment
# Group by Treatment and SymbiontTreatment, and calculate mean and standard error for percent change
raw_change_summary3 <- totaldf_long %>%
  filter(Treatment != "35.5") %>% 
  group_by(Treatment, SymbiontTreatment) %>%
  summarise(mean_raw_change = mean(RawChangeFvFm, na.rm = TRUE),
            se_raw_change = sd(RawChangeFvFm, na.rm = TRUE) / sqrt(n()))

# Reorder the Treatment factor in the desired order
raw_change_summary3 <- raw_change_summary3 %>%
  mutate(Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5")))

# Plot the percent change in area with error bars and custom colors
raw_change_plot3 <- ggplot(raw_change_summary3, aes(x = Treatment, y = mean_raw_change, shape = SymbiontTreatment)) +
  geom_point(size = 4, stroke = 1.5) +
  geom_errorbar(aes(ymin = mean_raw_change - se_raw_change, ymax = mean_raw_change + se_raw_change), 
                width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  # Add dashed line at y = 0
  labs(x = "Temperature (Treatment)", y = "Raw Change in Fv/Fm (± s.e.)",
       title = "Raw Change in Larval Fv/Fm from Timepoint 4 to 22") +
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),  # Remove major grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    axis.line = element_line(color = "black"),  # Keep x and y axis lines
    axis.ticks = element_line(color = "black")  # Add axis ticks
  )

# Display the plot
print(raw_change_plot3)

library(patchwork)

# Combine the two plots side by side
combined_plot_raw_fvfm <- raw_change_plot2 + raw_change_plot3 + plot_layout(ncol = 2)

# Display the combined plot
print(combined_plot_raw_fvfm)

# Save the combined plot as a PNG file
ggsave("C:/Users/jc980786/OneDrive - James Cook University/Australia/Ningaloo Spawning 2024/combined_plot_raw_fvfm_inset.png", plot = combined_plot_raw_fvfm, width = 6, height = 3, dpi = 300)
```

Raw change in FVFM for survivors

```{r}
# Group by Treatment, Cross_2, and SymbiontTreatment, and calculate mean and standard error for percent change
raw_change_fvfm_summary <- totaldf_long %>%
  filter(Timepoint == 22, Status == 0) %>%
  group_by(Treatment, Cross_2, SymbiontTreatment, ReefMom) %>%
  summarise(
    mean_raw_change = mean(RawChangeFvFm, na.rm = TRUE),
    se_raw_change = sd(RawChangeFvFm, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

# Reorder the Treatment factor in the desired order
raw_change_fvfm_summary <- raw_change_fvfm_summary %>%
  mutate(Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5")))

# Identify all combinations that should be present
all_combos <- expand.grid(
  Treatment = c("Ambient", "31"),
  SymbiontTreatment = unique(raw_change_fvfm_summary$SymbiontTreatment),
  Cross_2 = unique(raw_change_fvfm_summary$Cross_2),
  ReefMom = unique(raw_change_fvfm_summary$ReefMom)
)

# Join with existing data
raw_change_fvfm_summary <- all_combos %>%
  left_join(raw_change_fvfm_summary, by = c("Treatment", "SymbiontTreatment", "Cross_2", "ReefMom")) %>%
  mutate(
    Timepoint = 22,
    mean_raw = ifelse(is.na(mean_raw_change), 0, mean_raw_change),
    se_raw_change = ifelse(is.na(se_raw_change), 0, se_raw_change)
  )

# Define a custom color palette (same as before)
custom_colors <- c("CC" = "#1f77b4", "WW" = "#ff7f0e")  # Modify colors as needed

# Plot percent change in area with colors assigned to Cross_2 and separate panels for Family
survivors_raw_change <- ggplot(raw_change_fvfm_summary, aes(
  x = Treatment,
  y = mean_raw_change,
  fill = Cross_2,
  shape = SymbiontTreatment,
  group = interaction(Cross_2, SymbiontTreatment)
)) +
  # Colored lines connecting points
  geom_line(aes(color = Cross_2), linewidth = 0.8) +

  # Error bars colored by fill
  geom_errorbar(aes(
    ymin = mean_raw_change - se_raw_change,
    ymax = mean_raw_change + se_raw_change,
    color = Cross_2
  ), width = 0.2) +

  # Points with black border and colored fill
  geom_point(size = 4, stroke = 1.2, color = "black") +

  # Reference line at 0
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +

  # Manual color and shape control
  scale_fill_manual(values = custom_colors) +
  scale_color_manual(values = custom_colors) +
  scale_shape_manual(values = c("C" = 21, "D" = 24)) +

  # Labels and faceting
  labs(
    x = "Temperature (Treatment)",
    y = "Raw Change in Fv/Fm (± s.e.)",
    title = "Raw Change in Larval Fv/Fm (Survived to Timepoint 22)"
  ) +
  facet_wrap(~ ReefMom, nrow = 7) +

  # Theme styling
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.5),
    axis.ticks = element_line(color = "black")
  )


print(survivors_raw_change)

# Save the plot to a file
ggsave("C:/Users/jc980786/OneDrive - James Cook University/Australia/Ningaloo Spawning 2024/survivors_raw_change_plot.png", 
       plot = survivors_raw_change,  
       width = 10,          
       height = 7,          
       dpi = 300)           

```

Combine the 3 plots for size into one figure

```{r}
# Combine the three plots into one figure
combined_plot3 <- fvfm_plot + theme(legend.position = "none") + 
  raw_change_fvfm_plot + theme(legend.position = "none") +
  survivors_raw_change + theme(legend.position = "none") +
  plot_layout(ncol = 3)  # Stack them vertically (1 column)

# Display the combined plot
print(combined_plot3)

ggsave("C:/Users/jc980786/OneDrive - James Cook University/Australia/Ningaloo Spawning 2024/combined_plot_fvfm_raw.png", 
       plot = combined_plot3,  
       width = 10,          
       height = 7,          
       dpi = 300)           

```
Percentage of Larvae with Cells: line graphs
```{r}
library(dplyr)
library(ggplot2)
library(patchwork)  # for plot_layout()

# Replace NA values with zeros in PercentageWithCells column
summary_df2_survived$PercentageWithCells[is.na(summary_df2_survived$PercentageWithCells)] <- 0

summary_df2_survived <- summary_df2_survived %>%
  mutate(Cross = case_when(
    ReefMom %in% c("BT2", "BT4", "BT8") ~ "CC",
    TRUE ~ "WW"
  ))

summary_df2_survived %>%
  group_by(Timepoint, SymbiontTreatment, Treatment) %>%
  summarise(n = sum(!is.na(PercentageWithCells))) %>%
  print(n = Inf)

str(summary_df2_survived$PercentageWithCells)

# Filter the dataframe to get data for the final timepoint (22)
summary_stats_day22 <- summary_df2_survived %>%
  filter(Timepoint == 22) %>%
  group_by(Timepoint, SymbiontTreatment, Treatment, Cross) %>%
  summarise(
    mean_pct = mean(PercentageWithCells, na.rm = TRUE),
    n = sum(!is.na(PercentageWithCells)),
    sd_pct = ifelse(n > 1, sd(PercentageWithCells, na.rm = TRUE), NA_real_),
    se = ifelse(n > 1, sd_pct / sqrt(n), NA_real_),
    ci_lower = ifelse(n > 1, mean_pct - qt(0.975, df = n - 1) * se, NA_real_),
    ci_upper = ifelse(n > 1, mean_pct + qt(0.975, df = n - 1) * se, NA_real_)
  ) %>%
  ungroup()

# Set factor levels BEFORE plotting, to retain all x-axis categories
summary_stats_day22 <- summary_stats_day22 %>%
  mutate(Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5")))

# Make a full combination of all groups you'd expect at Timepoint 22
all_combos <- expand.grid(
  Treatment = c("Ambient", "31", "35.5"),
  SymbiontTreatment = unique(summary_stats_day22$SymbiontTreatment),
  Cross = unique(summary_stats_day22$Cross)
)

# Merge with your summary data
summary_stats_day22 <- all_combos %>%
  left_join(summary_stats_day22, by = c("Treatment", "SymbiontTreatment", "Cross")) %>%
  mutate(
    Timepoint = 22,
    mean_pct = ifelse(is.na(mean_pct), 0, mean_pct),
    se = ifelse(is.na(se), 0, se),
    TREATMENT = factor(Treatment, levels = c("Ambient", "31", "35.5"))
  )

summary_stats_day22$SymbiontTreatment <- factor(
  summary_stats_day22$SymbiontTreatment,
  levels = c("C", "D")  # or whatever levels you actually have
)

# Reorder the Treatment factor in the desired order
#final_timepoint_df <- final_timepoint_df %>%
#  mutate(TREATMENT = factor(TREATMENT, levels = c("Ambient", "31", "35.5")))

# Define a custom color palette
custom_colors <- c("CC" = "#1f77b4", "WW" = "#ff7f0e") # Modify as needed

# Plot mean PercentageWithCells with error bars and custom colors
pct_plot <- ggplot(summary_stats_day22, aes(
  x = Treatment,
  y = mean_pct,
  fill = Cross,
  shape = SymbiontTreatment
)) +
  # Error bars take the fill color
  geom_errorbar(
    aes(ymin = mean_pct - se, ymax = mean_pct + se, color = Cross),
    width = 0.2
  ) +

  # Points with black outlines and colored fill
  geom_point(
    size = 4,
    stroke = 1.2,
    color = "black"  # black border
  ) +

  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +

  scale_fill_manual(values = custom_colors) +
  scale_color_manual(values = custom_colors) +  # for error bars
  scale_shape_manual(values = c("C" = 21, "D" = 24)) +

  labs(
    x = "Temperature Treatment",
    y = "Mean % With Cells (± s.e.)",
    title = "Mean Percentage With Cells at Final Timepoint (22)"
  ) +

  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black")
  )

print(pct_plot)

# Create inset plot by Treatment only
final_timepoint_df_inset <- summary_df2_survived %>%
  filter(TIMEPOINT == 22) %>%
  group_by(TREATMENT) %>%
  summarise(
    mean_pct = mean(PercentageWithCells, na.rm = TRUE),
    se_pct = sd(PercentageWithCells, na.rm = TRUE) / sqrt(n())
  ) %>%
  mutate(Treatment = factor(TREATMENT, levels = c("T1", "T2", "T3")))

mean_pct_plot <- ggplot(final_timepoint_df_inset, aes(x = TREATMENT, y = mean_pct)) +
  geom_point(size = 4, shape = 1, fill = NA, stroke = 1.5) +
  geom_errorbar(aes(ymin = mean_pct - se_pct, ymax = mean_pct + se_pct), width = 0.2) +
  labs(x = "Temperature Treatment", y = "Mean % With Cells (± s.e.)",
       title = "Mean Percentage With Cells at Final Timepoint (All Crosses and Symbiont Treatments)") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.5)
  )

print(mean_pct_plot)

# Create inset plot separated by Treatment and SymbiontTreatment
final_timepoint_df_inset2 <- summary_df3_survived %>%
  filter(DayNumber == 22) %>%
  group_by(TREATMENT, SymbiontTreatment) %>%
  summarise(
    mean_pct = mean(PercentageWithCells, na.rm = TRUE),
    se_pct = sd(PercentageWithCells, na.rm = TRUE) / sqrt(n())
  ) %>%
  mutate(Treatment = factor(TREATMENT, levels = c("Ambient", "31", "35.5")))

mean_pct_plot2 <- ggplot(final_timepoint_df_inset2, aes(x = TREATMENT, y = mean_pct, shape = SymbiontTreatment)) +
  geom_point(size = 4, fill = NA, stroke = 1.5) +
  geom_errorbar(aes(ymin = mean_pct - se_pct, ymax = mean_pct + se_pct), width = 0.2) +
  labs(x = "Temperature Treatment", y = "Mean % With Cells (± s.e.)",
       title = "Mean Percentage With Cells at Final Timepoint (All Crosses and Symbiont Treatments)") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.5)
  )

print(mean_pct_plot2)

# Combine the two inset plots side by side
library(patchwork)

combined_pct_plot <- mean_pct_plot + mean_pct_plot2 + plot_layout(ncol = 2)
print(combined_pct_plot)

# Save combined plot
ggsave("C:/Users/jc980786/OneDrive - James Cook University/Australia/Ningaloo Spawning 2024/combined_plot_mean_percentage_with_cells_inset.png", plot = combined_pct_plot, width = 6, height = 3, dpi = 300)

```
PercentageWithCells from Day 1 to Day 22
```{r}
summary_df2_survived <- summary_df2_survived %>%
  group_by(SymbiontTreatment, Treatment, Cross) %>%
  mutate(PercentageWithCells_adj = PercentageWithCells + 0.01)

# Extract PercentageWithCells at Day 1
cells_day1 <- summary_df2_survived %>%
  filter(Timepoint == 1) %>%
  dplyr::select(Treatment, ReefMom, SymbiontTreatment, Cross, PercentageWithCells_adj) %>%
  rename(CellsDay1 = PercentageWithCells_adj)

# Extract PercentageWithCells at Day 22
cells_day22 <- summary_df2_survived %>%
  filter(Timepoint == 22) %>%
  dplyr::select(Treatment, ReefMom, SymbiontTreatment, Cross, PercentageWithCells_adj) %>%
  rename(CellsDay22 = PercentageWithCells_adj)

# Join Day 1 and Day 22 data
cells_change_df <- left_join(cells_day1, cells_day22,
                             by = c("Treatment", "ReefMom", "SymbiontTreatment", "Cross"))

# Calculate change
cells_change_df <- cells_change_df <- cells_change_df %>%
  mutate(AcquisitionChangeCells = (CellsDay22) - (CellsDay1))


# Summarize percent change by Treatment, Cross, SymbiontTreatment
perc_change_summary <- cells_change_df %>%
  group_by(Treatment, Cross, SymbiontTreatment) %>%
  summarise(
    mean_perc_change = mean(AcquisitionChangeCells, na.rm = TRUE),
    se_perc_change = sd(AcquisitionChangeCells, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

# Reorder treatment levels
perc_change_summary <- perc_change_summary %>%
  mutate(Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5")))

# Plot
log_change_plot2 <- ggplot(perc_change_summary, aes(
  x = Treatment,
  y = mean_perc_change,
  fill = Cross,  # use fill instead of color
  shape = SymbiontTreatment
)) +
  # Colored error bars based on Cross
  geom_errorbar(aes(
    ymin = mean_perc_change - se_perc_change,
    ymax = mean_perc_change + se_perc_change,
    color = Cross  # error bar matches fill
  ), width = 0.2) +

  # Points: colored fill, black border
  geom_point(
    size = 4,
    stroke = 1.2,
    color = "black"  # black outline
  ) +

  # Add reference line
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +

  # Manual color scales
  scale_fill_manual(values = custom_colors) +   # for fill in points
  scale_color_manual(values = custom_colors) +  # for error bars
  scale_shape_manual(values = c(21, 24)) +      # use filled shapes

  # Labels & styling
  labs(
    x = "Temperature (Treatment)",
    y = "Change in % Larvae With Cells (± s.e.)",
    title = "Change in Symbiotic Larvae from Day 1 to 22"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black")
  )


# Show plot
print(log_change_plot2)

# Summarize log change by TREATMENT only
perc_change_inset1 <- cells_change_df %>%
  filter(TREATMENT != "T3") %>%  # Remove T3 before summary
  group_by(TREATMENT) %>%
  summarise(
    mean_perc_change = mean(AcquisitionChangeCells, na.rm = TRUE),
    se_perc_change = sd(AcquisitionChangeCells, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  mutate(Treatment = factor(TREATMENT, levels = c("T1", "T2")))

perc_change_plot_inset1 <- ggplot(perc_change_inset1, aes(x = Treatment, y = mean_perc_change)) +
  geom_point(size = 4, shape = 1, stroke = 1.5) +
  geom_errorbar(aes(ymin = mean_perc_change - se_perc_change,
                    ymax = mean_perc_change + se_perc_change), width = 0.2) +
  labs(x = "Temperature (Treatment)", y = "Change in % With Cells (± s.e.)") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.5)
  )

perc_change_inset2 <- cells_change_df %>%
  filter(TREATMENT != "T3") %>%  # Remove T3 before summary
  group_by(TREATMENT, SymbiontTreatment) %>%
  summarise(
    mean_perc_change = mean(AcquisitionChangeCells, na.rm = TRUE),
    se_perc_change = sd(AcquisitionChangeCells, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  mutate(Treatment = factor(TREATMENT, levels = c("T1", "T2")))

perc_change_plot_inset2 <- ggplot(perc_change_inset2, aes(x = Treatment, y = mean_perc_change, shape = SymbiontTreatment)) +
  geom_point(size = 4, stroke = 1.5) +
  geom_errorbar(aes(ymin = mean_perc_change - se_perc_change,
                    ymax = mean_perc_change + se_perc_change), width = 0.2) +
  labs(x = "Temperature (Treatment)", y = "Log Change in % With Cells (± s.e.)") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.5)
  )


library(patchwork)

# Combine the insets
combined_perc_change_insets <- perc_change_plot_inset1 + perc_change_plot_inset2 + plot_layout(ncol = 2)

# Print
print(combined_perc_change_insets)

ggsave("C:/Users/bellb/OneDrive - James Cook University/Australia/Ningaloo Spawning 2024/combined_perc_change_insets_pct.png", plot = combined_perc_change_insets,
       width = 6, height = 3, dpi = 300)

```

```{r}
summary_df2_survived <- summary_df2_survived %>%
  group_by(SymbiontTreatment, TREATMENT, Cross, ReefMom) %>%
  mutate(PercentageWithCells_adj = PercentageWithCells + 0.01)

# Extract PercentageWithCells at Day 1
cells_day1 <- summary_df2_survived %>%
  filter(TIMEPOINT == 1) %>%
  dplyr::select(TREATMENT, ReefMom, SymbiontTreatment, Cross, PercentageWithCells_adj) %>%
  rename(CellsDay1 = PercentageWithCells_adj)

# Extract PercentageWithCells at Day 22
cells_day22 <- summary_df2_survived %>%
  filter(TIMEPOINT == 22) %>%
  dplyr::select(TREATMENT, ReefMom, SymbiontTreatment, Cross, PercentageWithCells_adj) %>%
  rename(CellsDay22 = PercentageWithCells_adj)

# Join Day 1 and Day 22 data
cells_change_df <- left_join(cells_day1, cells_day22,
                             by = c("TREATMENT", "ReefMom", "SymbiontTreatment", "Cross"))

# Calculate log change
cells_change_df <- cells_change_df <- cells_change_df %>%
  mutate(PercChangeCells_Acq = (CellsDay22) - (CellsDay1))

perc_change_summary2 <- cells_change_df %>%
  filter(TREATMENT != "T3") %>%  # Remove T3 before summary
  group_by(TREATMENT, Cross, SymbiontTreatment, ReefMom) %>%
  summarise(
    mean_perc_change = mean(PercChangeCells_Acq, na.rm = TRUE),
    se_perc_change = sd(PercChangeCells_Acq, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

# Reorder treatment levels
perc_change_summary2 <- perc_change_summary2 %>%
  mutate(Treatment = factor(TREATMENT, levels = c("T1", "T2")))

perc_change_plot3 <- ggplot(perc_change_summary2, aes(
  x = Treatment,
  y = mean_perc_change,
  fill = Cross,
  shape = SymbiontTreatment
)) +
  # Error bars colored by Cross
  geom_errorbar(aes(
    ymin = mean_perc_change - se_perc_change,
    ymax = mean_perc_change + se_perc_change,
    color = Cross
  ), width = 0.2) +

  # Points with black border and colored fill
  geom_point(
    size = 4,
    stroke = 1.2,
    color = "black"  # black outline
  ) +

  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +

  # Manual scales for fill and shape
  scale_fill_manual(values = custom_colors) +
  scale_color_manual(values = custom_colors) +
  scale_shape_manual(values = c(21, 22)) +

  labs(
    x = "Temperature (Treatment)",
    y = "Percent Change in % Larvae With Cells (± s.e.)",
    title = "Change in Symbiotic Larvae from Day 1 to 22"
  ) +

  facet_wrap(~ ReefMom, nrow = 7) +

  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black")
  )


# Display the faceted plot
print(perc_change_plot3)

perc_change_plot3 <- ggplot(perc_change_summary2, aes(
  x = Treatment,
  y = mean_perc_change,
  fill = Cross,
  shape = SymbiontTreatment
)) +
  # Lines connecting points of same Cross and SymbiontTreatment
  geom_line(aes(
    group = interaction(Cross, SymbiontTreatment),
    color = Cross
  ), linewidth = 0.8) +

  # Error bars colored by Cross
  geom_errorbar(aes(
    ymin = mean_perc_change - se_perc_change,
    ymax = mean_perc_change + se_perc_change,
    color = Cross
  ), width = 0.2) +

  # Points with colored fill and black border
  geom_point(
    size = 4,
    stroke = 1.2,
    color = "black"
  ) +

  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +

  # Scales and labels
  scale_fill_manual(values = custom_colors) +
  scale_color_manual(values = custom_colors) +
  scale_shape_manual(values = c(21, 24)) +

  labs(
    x = "Temperature (Treatment)",
    y = "Percent Change in % Larvae With Cells (± s.e.)",
    title = "Change in Symbiotic Larvae from Day 1 to 22"
  ) +

  facet_wrap(~ ReefMom, nrow = 7) +

  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black")
  )

```
Combine all of the plots
```{r}
# Combine the three plots into one figure
combined_plot_pct <- 
  pct_plot + 
    theme(legend.position = "none") +
  log_change_plot2 + 
    theme(legend.position = "none") +
  perc_change_plot3 + 
    theme(legend.position = "none") +
  plot_layout(ncol = 3)


# Display the combined plot
print(combined_plot_pct)

ggsave("C:/Users/bellb/OneDrive - James Cook University/Australia/Ningaloo Spawning 2024/combined_plot_pct_updated.png", 
       plot = combined_plot_pct,  # Save the most recent plot
       width = 10,          # Set the width of the plot (in inches)
       height = 7,          # Set the height of the plot (in inches)
       dpi = 300)           # Set the resolution (300 dpi is good for publications)  
```
Line graphs of Cell Density
```{r}
library(dplyr)
library(ggplot2)
library(patchwork)

# Replace NA values with zeros in Cell_Density
df_subset$Cell_Density[is.na(df_subset$Cell_Density)] <- 0

# Define crosses (adjust as needed)
df_subset <- df_subset %>%
  mutate(Cross = case_when(
    ReefMom %in% c("BT2", "BT4", "BT8") ~ "CC",
    TRUE ~ "WW"
  ))

# Set factor levels BEFORE plotting, to retain all x-axis categories
df_subset <- df_subset %>%
  mutate(Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5")))

# Filter for Day 22 and summarize
summary_stats_day22_cd <- df_subset %>%
  filter(Timepoint == 22) %>%
  group_by(Timepoint, SymbiontTreatment, Treatment, Cross) %>%
  summarise(
    mean_cd = mean(Cell_Density, na.rm = TRUE),
    n = sum(!is.na(Cell_Density)),
    sd_cd = ifelse(n > 1, sd(Cell_Density, na.rm = TRUE), NA_real_),
    se = ifelse(n > 1, sd_cd / sqrt(n), NA_real_),
    ci_lower = ifelse(n > 1, mean_cd - qt(0.975, df = n - 1) * se, NA_real_),
    ci_upper = ifelse(n > 1, mean_cd + qt(0.975, df = n - 1) * se, NA_real_)
  ) %>%
  ungroup()

# Identify all combinations that should be present
all_combos <- expand.grid(
  Treatment = c("Ambient", "31", "35.5"),
  SymbiontTreatment = unique(summary_stats_day22_cd$SymbiontTreatment),
  Cross = unique(summary_stats_day22_cd$Cross)
)

# Join with existing data
summary_stats_day22_cd <- all_combos %>%
  left_join(summary_stats_day22_cd, by = c("Treatment", "SymbiontTreatment", "Cross")) %>%
  mutate(
    Timepoint = 22,
    mean_cd = ifelse(is.na(mean_cd), 0, mean_cd),
    se = ifelse(is.na(se), 0, se)
  )

# Define custom colors
custom_colors <- c("CC" = "#1f77b4", "WW" = "#ff7f0e")

# Plot main Cell Density plot
cd_plot <- ggplot(summary_stats_day22_cd, aes(
  x = Treatment,
  y = mean_cd,
  fill = Cross,                    # fill color by Cross
  shape = SymbiontTreatment        # shape by symbiont
)) +
  geom_errorbar(
    aes(ymin = mean_cd - se, ymax = mean_cd + se, color = Cross), 
    width = 0.2
  ) +
  geom_point(
    size = 4,
    stroke = 1.2,
    color = "black"                # black border
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  scale_fill_manual(values = custom_colors) +
  scale_color_manual(values = custom_colors) +  # for error bars
  scale_shape_manual(values = c("C" = 21, "D" = 24)) +
  labs(
    x = "Temperature Treatment",
    y = "Mean Cell Density (± s.e.)",
    title = "Mean Cell Density at Final Timepoint (22)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black")
  )


print(cd_plot)

ggsave("C:/Users/bellb/OneDrive - James Cook University/Australia/Ningaloo Spawning 2024/Larval Infection Experiment/cell_density_mean_plot.png", plot = cd_plot,
       width = 6, height = 3, dpi = 300)

#Mean cell density by Treatment
final_timepoint_df_inset_cd <- df_subset %>%
  filter(Timepoint == 22) %>%
  group_by(Treatment) %>%
  summarise(
    mean_cd = mean(Cell_Density, na.rm = TRUE),
    se_cd = sd(Cell_Density, na.rm = TRUE) / sqrt(n())
  ) %>%
  mutate(Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5")))

mean_cd_plot <- ggplot(final_timepoint_df_inset_cd, aes(x = Treatment, y = mean_cd)) +
  geom_point(size = 4, shape = 1, fill = NA, stroke = 1.5) +
  geom_errorbar(aes(ymin = mean_cd - se_cd, ymax = mean_cd + se_cd), width = 0.2) +
  labs(x = "Temperature Treatment", y = "Mean Cell Density (± s.e.)",
       title = "Mean Cell Density at Final Timepoint (All Crosses and Symbiont Treatments)") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.5)
  )
print(mean_cd_plot)

#Inset by Treatment x SymbiontTreatment
final_timepoint_df_inset_cd2 <- df_subset %>%
  filter(Timepoint == 22) %>%
  group_by(Treatment, SymbiontTreatment) %>%
  summarise(
    mean_cd = mean(Cell_Density, na.rm = TRUE),
    se_cd = sd(Cell_Density, na.rm = TRUE) / sqrt(n())
  ) %>%
  mutate(Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5")))

mean_cd_plot2 <- ggplot(final_timepoint_df_inset_cd2, aes(x = Treatment, y = mean_cd, shape = SymbiontTreatment)) +
  geom_point(size = 4, fill = NA, stroke = 1.5) +
  geom_errorbar(aes(ymin = mean_cd - se_cd, ymax = mean_cd + se_cd), width = 0.2) +
  labs(x = "Temperature Treatment", y = "Mean Cell Density (± s.e.)",
       title = "Mean Cell Density at Final Timepoint (All Crosses and Symbiont Treatments)") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.5)
  )

combined_cd_plot <- mean_cd_plot + mean_cd_plot2 + plot_layout(ncol = 2)
print(combined_cd_plot)

# Save combined inset plot
ggsave("C:/Users/jc980786/OneDrive - James Cook University/Australia/Ningaloo Spawning 2024/Larval Infection Experiment/combined_plot_cell_density_inset.png", plot = combined_cd_plot,
       width = 6, height = 3, dpi = 300)

```
Percent change difference between T0 and T22
```{r}
library(dplyr)
library(ggplot2)
library(patchwork)

# Make sure Cross is added and standardized at the beginning
class(df_subset$Cross)
df_subset$Cross <- factor(df_subset$Cross, levels = c("CC", "WW"))
levels(df_subset$Cross)

#add sign-log
df_subset$sign_log_PercChangeCells <- sign(df_subset$PercChangeCells) * 
                                            log1p(abs(df_subset$PercChangeCells))


# Define custom colors
custom_colors <- c("CC" = "#1f77b4", "WW" = "#ff7f0e")

df_subset$Treatment[is.na(df_subset$Treatment)] <- "Ambient"


df_subset$Treatment <- factor(df_subset$Treatment, levels = c("Ambient", "31", "35.5"))

# Summarize percent change by Treatment, Cross, SymbiontTreatment
log_change_summary <- df_subset %>%
  group_by(Treatment, Cross, SymbiontTreatment) %>%
  summarise(
    mean_log_change = mean(sign_log_PercChangeCells, na.rm = TRUE),
    se_log_change = sd(sign_log_PercChangeCells, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  complete(Treatment, Cross, SymbiontTreatment)  # adds missing combinations as NA


# Main plot
log_change_plot_cells <- ggplot(log_change_summary, aes(
  x = Treatment,
  y = mean_log_change,
  fill = Cross,
  shape = SymbiontTreatment
)) +
  geom_errorbar(
    aes(ymin = mean_log_change - se_log_change,
        ymax = mean_log_change + se_log_change,
        color = Cross),
    width = 0.2
  ) +
  geom_point(
    size = 4,
    stroke = 1.2,
    color = "black"  # black border
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  scale_fill_manual(values = custom_colors) +
  scale_color_manual(values = custom_colors) +  # for error bars
  scale_shape_manual(values = c("C" = 21, "D" = 24)) +  # shape for symbionts
  labs(
    x = "Temperature (Treatment)",
    y = "Log Change in Cell Density (± s.e.)",
    title = "Log Change in Cell Density from Timepoint 1 to 22"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black")
  )


print(log_change_plot_cells)

#Log change by Treatment only
inset1_df <- df_subset %>%
  filter(Treatment != "35.5") %>% 
  group_by(Treatment) %>%
  summarise(
    mean_log_change = mean(sign_log_PercChangeCells, na.rm = TRUE),
    se_log_change = sd(sign_log_PercChangeCells, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  mutate(Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5")))

inset1_plot <- ggplot(inset1_df, aes(x = Treatment, y = mean_log_change)) +
  geom_point(size = 4, shape = 1, color = "black", fill = NA, stroke = 1.5) +
  geom_errorbar(aes(ymin = mean_log_change - se_log_change, ymax = mean_log_change + se_log_change), width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  labs(title = "Mean Log Change by Treatment", y = "Log Change (± s.e.)", x = NULL) +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.5),
    axis.title.y = element_text(size = 10),
    plot.title = element_text(size = 10, hjust = 0.5),
    axis.title.x = element_blank()
  )


# Inset 2: Mean log change by Treatment and SymbiontTreatment (point + error bars)
inset2_df <- df_subset %>%
  filter(Treatment != "35.5") %>%
  group_by(Treatment, SymbiontTreatment) %>%
  summarise(
   mean_log_change = mean(sign_log_PercChangeCells, na.rm = TRUE),
    se_log_change = sd(sign_log_PercChangeCells, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  mutate(Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5")))

inset2_plot <- ggplot(inset2_df, aes(x = Treatment, y = mean_log_change, shape = SymbiontTreatment)) +
  geom_point(size = 4, fill = NA, stroke = 1.5) +
  geom_errorbar(aes(ymin = mean_log_change - se_log_change, ymax = mean_log_change + se_log_change), width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  labs(x = NULL, y = "Log Change (± s.e.)", title = "Log Change by Treatment × Symbiont") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.5),
    plot.title = element_text(size = 10, hjust = 0.5),
    axis.title.x = element_blank()
  )


combined_cd_plot2 <- inset1_plot + inset2_plot + plot_layout(ncol = 2)
print(combined_cd_plot2)

# Save combined inset plot
ggsave("C:/Users/jc980786/OneDrive - James Cook University/Australia/Ningaloo Spawning 2024/Larval Infection Experiment/combined_plot_cell_density_percchange_inset_log.png", plot = combined_cd_plot2,
       width = 6, height = 3, dpi = 300)


```
Cell Density by ReefMom (Log transformed)
```{r}
# Summarize perc change including ReefMom
log_change_summary_by_reef <- df_subset %>%
  filter(Treatment != "35.5") %>%
  group_by(Treatment, Cross, SymbiontTreatment, ReefMom) %>%
  summarise(
    mean_log_change = mean(sign_log_PercChangeCells, na.rm = TRUE),
    se_log_change = sd(sign_log_PercChangeCells, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  mutate(Treatment = factor(Treatment, levels = c("Ambient", "31", "35.5")))

# Plot faceted by ReefMom
log_change_plot_faceted <- ggplot(log_change_summary_by_reef, 
                                   aes(x = Treatment, y = mean_log_change,
                                       fill = Cross, shape = SymbiontTreatment)) +
  # Connect points with same color as fill
  geom_line(aes(group = interaction(Cross, SymbiontTreatment), color = Cross), 
            size = 0.8) +
  
  # Error bars with Cross color
  geom_errorbar(aes(ymin = mean_log_change - se_log_change,
                    ymax = mean_log_change + se_log_change,
                    color = Cross), 
                width = 0.2) +
  
  # Points with black border and colored fill
  geom_point(size = 4, stroke = 1.2, color = "black") +
  
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  
  scale_fill_manual(values = custom_colors) +
  scale_color_manual(values = custom_colors) +
  scale_shape_manual(values = c("C" = 21, "D" = 24)) +  # triangle and circle

  labs(x = "Temperature (Treatment)", 
       y = "Log Change in Cell Density (± s.e.)",
       title = "Log Change in Cell Density from Timepoint 1 to 22") +
  
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black")
  ) +
  facet_wrap(~ ReefMom, nrow = 7)

print(log_change_plot_faceted)


```

Combine all of the plots
```{r}
# Combine the three plots into one figure
combined_plot_cd <- cd_plot + 
    theme(legend.position = "none") +
  log_change_plot_cells + 
    theme(legend.position = "none") + log_change_plot_faceted + 
    theme(legend.position = "none") +
  plot_layout(ncol = 3)  # Stack them vertically (1 column)

# Display the combined plot
print(combined_plot_cd)

ggsave("C:/Users/jc980786/OneDrive - James Cook University/Australia/Ningaloo Spawning 2024/combined_plot_cd_log.png", 
       plot = combined_plot_cd,  # Save the most recent plot
       width = 10,          # Set the width of the plot (in inches)
       height = 7,          # Set the height of the plot (in inches)
       dpi = 300)           # Set the resolution (300 dpi is good for publications)  
```

##Percentage of Larvae that Acquired Cells with Source Reef
```{r}
#Percentage with Cells ############################################

# Ensure factors are ordered
library(dplyr)

ipam <- ipam %>%
  mutate(
    TEMP = case_when(
      near(TEMP, 27.5) ~ "Ambient",
      near(TEMP, 31) ~ "31",
      near(TEMP, 35.5) ~ "35.5",
      TRUE ~ as.character(TEMP)
    ),
    Reef = recode(Reef, "Bruboodjoo" = "CC", "Tantabiddi" = "WW"),
    SymbiontTreatment = factor(zoox, levels = c("C", "D")),
    Treatment = factor(TEMP, levels = c("Ambient", "31", "35.5")),
    Cross = factor(Reef, levels = c("CC", "WW"))
  )

#df_subset$logChangeCells <- log(df_subset$PercChangeCells + 1)

#check how many observations per group
table(ipam$SymbiontTreatment, ipam$Cross, ipam$Treatment)

#include replicates
ipam <- ipam %>%
  rename(Timepoint = TIMEPOINT)

ipam <- ipam %>%
  mutate(Timepoint = as.character(Timepoint)) %>%
  left_join(
    df_with_extremes %>%
      mutate(Timepoint = as.character(Timepoint)) %>%
      dplyr::select(UniqueID, Timepoint, Replicate) %>%
      distinct(),
    by = c("UniqueID", "Timepoint")
  )

summary(ipam[, c("PercChangeCells", "SymbiontTreatment", "Cross", "Treatment")])

#set prior
prior <- list(
  R = list(V = 1, nu = 0.002),  # Residual variance (Gaussian default)
  G = list(
    G1 = list(V = 1, nu = 0.002)  # Random effect for Replicate
  )
)

#model
model_perc <- MCMCglmm(
  PercChangeCells ~ SymbiontTreatment * Cross * Treatment,
  random = ~ Replicate,
  data = ipam,
  family = "gaussian",
  prior = prior,
  nitt = 50000,
  burnin = 10000,
  thin = 20
)

summary(model_perc)

#Check chain convergence and mixing
library(coda)
mcmc_obj <- as.mcmc(model_perc$Sol)
plot(mcmc_obj)              # Trace and density plots
autocorr.diag(mcmc_obj)     # Autocorrelation
effectiveSize(mcmc_obj)     # Effective sample size

newdat_perc <- expand.grid(
  SymbiontTreatment = levels(ipam$SymbiontTreatment),
  Cross = levels(ipam$Cross),
  Treatment = levels(ipam$Treatment)  
)

newdat_perc$SymbiontTreatment <- factor(newdat_perc$SymbiontTreatment, levels = levels(ipam$SymbiontTreatment))
newdat_perc$Cross <- factor(newdat_perc$Cross, levels = levels(ipam$Cross))
newdat_perc$Treatment <- factor(newdat_perc$Treatment, levels = levels(ipam$Treatment))

lapply(newdat_perc[, c("SymbiontTreatment", "Cross", "Treatment")], function(x) length(unique(x)))


X_full_subset <- model.matrix(~ SymbiontTreatment * Cross * Treatment, data = newdat_perc)
X_subset <- X_full_subset[, colnames(model_perc$Sol), drop = FALSE]

pred_matrix_subset <- X_subset %*% t(model_perc$Sol)
newdat_perc$pred_mean <- rowMeans(pred_matrix_subset)
newdat_perc$lower <- apply(pred_matrix_subset, 1, quantile, probs = 0.025)
newdat_perc$upper <- apply(pred_matrix_subset, 1, quantile, probs = 0.975)
newdat_perc$significant <- !(newdat_perc$lower < 0 & newdat_perc$upper > 0)
newdat_perc$label_combined <- paste0(round(newdat_perc$pred_mean, 2),
                                       ifelse(newdat_perc$significant, "*", ""))
# Calculate pMCMC values: two-tailed test for each posterior distribution
newdat_perc$pMCMC <- apply(pred_matrix_subset, 1, function(x) {
  2 * min(mean(x > 0), mean(x < 0))
})

#Global mean
# Vector of posterior means across all groups for each MCMC iteration
global_mean_post_subset <- colMeans(pred_matrix_subset)
# Difference: each group's posterior - global mean at each MCMC iteration
diff_matrix_global_subset <- sweep(pred_matrix_subset, 2, global_mean_post_subset, FUN = "-")
# pMCMC: two-tailed probability that the difference ≠ 0
pMCMC_vals <- apply(diff_matrix_global_subset, 1, function(x) {
  mean(x < 0) * 2 * (mean(x < 0) < 0.5) + mean(x > 0) * 2 * (mean(x > 0) < 0.5)
})
diff_summary_global_subset <- as.data.frame(t(apply(diff_matrix_global_subset, 1, function(x) {
  q <- quantile(x, probs = c(0.025, 0.975))
  c(mean_diff = mean(x), lower = q[1], upper = q[2])
})))

colnames(diff_summary_global_subset) <- c("mean_global", "lower_global", "upper_global")

diff_summary_global_subset$pMCMC <- pMCMC_vals
diff_summary_global_subset$signif_label_global <- case_when(
  pMCMC_vals < 0.005 ~ "**",
  pMCMC_vals < 0.05  ~ "*",
  TRUE               ~ ""
)

diff_summary_global_subset$label_combined_global <- paste0(
  round(diff_summary_global_subset$mean_global, 2),
  diff_summary_global_subset$signif_label_global
)

diff_summary_global_subset <- as.data.frame(diff_summary_global_subset)
diff_summary_global_subset$significant_vs_global <- with(diff_summary_global_subset, lower_global > 0 | upper_global < 0)

newdat_perc <- cbind(newdat_perc, diff_summary_global_subset)

ggplot(newdat_perc, aes(x = Treatment, y = Cross, fill = pred_mean)) +
  geom_tile(color = "white") +
  geom_text(aes(label = label_combined), color = "black", size = 4) +
  facet_wrap(~ SymbiontTreatment) +
  scale_fill_viridis_c(name = "Predicted cell change %") +
  theme_minimal() +
  labs(title = "Predicted Change in Cell Density (No 35.5)",
       x = "Treatment", y = "Host Genotype")


#############################
### Modeling variables separate for each health metric to get relative contributions ###
#PercChangeCells ~ SymbiontTreatment * Cross * Treatment

# Load MCMCglmm if not already loaded
library(MCMCglmm)

# Your prior (make sure it's defined appropriately)
# Example placeholder:
prior <- list(R = list(V = 1, nu = 0.002), G = list(G1 = list(V = 1, nu = 0.002)))

# Full model formula
full_formula <- PercChangeCells ~ SymbiontTreatment * Cross * Treatment

# Fit the full model
model_full <- MCMCglmm(full_formula,
  random = ~ Replicate,
  data = ipam,
  family = "gaussian",
  prior = prior,
  nitt = 50000,
  burnin = 10000,
  thin = 20
)

# Fit single fixed effect models
mod_perc_Treatment <- MCMCglmm(PercChangeCells ~ Treatment, 
                          random = ~ Replicate , 
                          data = ipam, 
                          family = "gaussian", 
                          prior = prior, 
                          nitt = 50000, 
                          burnin = 10000, 
                          thin = 20)

mod_perc_symbiont <- MCMCglmm(PercChangeCells ~ SymbiontTreatment, 
                         random = ~ Replicate , 
                         data = ipam, 
                         family = "gaussian", 
                         prior = prior, 
                         nitt = 50000, 
                         burnin = 10000, 
                         thin = 20)

mod_perc_family <- MCMCglmm(PercChangeCells ~ Cross, 
                       random = ~ Replicate , 
                       data = ipam, 
                       family = "gaussian", 
                       prior = prior, 
                       nitt = 50000, 
                       burnin = 10000, 
                       thin = 20)

# Helper function to calculate marginal R²
calc_marginal_R2 <- function(model, data, fixed_formula) {
  # Build model matrix for fixed effects (includes intercept)
  X <- model.matrix(fixed_formula, data = data)
  
  # Extract posterior samples of fixed effects
  Sol <- model$Sol
  
  # Identify which columns in Sol correspond to fixed effects (including intercept)
  fixed_effect_names <- colnames(Sol)
  
  # Align columns of X and Sol by name
  # Remove any columns in X not present in Sol (unlikely, but safe)
  cols_to_keep <- colnames(X) %in% fixed_effect_names
  X_sub <- X[, cols_to_keep, drop = FALSE]
  
  # Subset Sol to columns matching X_sub
  Sol_sub <- Sol[, colnames(X_sub), drop = FALSE]
  
  # Now dimensions should align for multiplication: X_sub (n x p), t(Sol_sub) (p x samples)
  
  if (ncol(X_sub) != ncol(Sol_sub)) {
    stop("Mismatch between fixed effect columns in design matrix and posterior samples.")
  }
  
  # Calculate linear predictor samples: each row = one observation,
  # each column = one MCMC iteration sample
  linpred_samples <- X_sub %*% t(Sol_sub)  # dimensions: nrow(X_sub) x nrow(Sol_sub)
  
  # Variance of predicted values for each MCMC iteration
  var_fixed <- apply(linpred_samples, 2, var)
  
  # Variance components for random effects and residual
  # Here, adjust grep pattern if you have multiple random effects or different names
  var_random <- rowSums(model$VCV[, grep("Replicate", colnames(model$VCV)), drop = FALSE])
  var_resid <- model$VCV[, "units"]
  
  # Marginal R² per iteration
  R2_marginal <- var_fixed / (var_fixed + var_random + var_resid)
  
  # Return mean and 95% credible interval
  c(
    mean = mean(R2_marginal),
    lower = quantile(R2_marginal, 0.025),
    upper = quantile(R2_marginal, 0.975)
  )
}

# Calculate marginal R2 for all models
r2_full <- calc_marginal_R2(model_full, ipam, full_formula)
r2_Treatment <- calc_marginal_R2(mod_perc_Treatment, ipam, PercChangeCells ~ Treatment)
r2_symbiont <- calc_marginal_R2(mod_perc_symbiont, ipam, PercChangeCells ~ SymbiontTreatment)
r2_cross2 <- calc_marginal_R2(mod_perc_family, ipam, PercChangeCells ~ Cross)

# Print results
cat("Marginal R² for full model (all fixed effects + interactions):\n")
print(r2_full)
cat("\nMarginal R² for Treatment only model:\n")
print(r2_Treatment)
cat("\nMarginal R² for SymbiontTreatment only model:\n")
print(r2_symbiont)
cat("\nMarginal R² for Cross only model:\n")
print(r2_cross2)


calc_marginal_conditional_R2 <- function(model, data, fixed_formula) {
  X <- model.matrix(fixed_formula, data = data)
  Sol <- model$Sol
  
  cols_to_keep <- colnames(X) %in% colnames(Sol)
  X_sub <- X[, cols_to_keep, drop = FALSE]
  Sol_sub <- Sol[, colnames(X_sub), drop = FALSE]
  
  if (ncol(X_sub) != ncol(Sol_sub)) stop("Mismatch in fixed effect columns.")
  
  linpred_samples <- X_sub %*% t(Sol_sub)
  var_fixed <- apply(linpred_samples, 2, var)
  
  var_random <- rowSums(model$VCV[, grep("Replicate", colnames(model$VCV)), drop = FALSE])
  var_resid <- model$VCV[, "units"]
  
  R2_marginal <- var_fixed / (var_fixed + var_random + var_resid)
  R2_conditional <- (var_fixed + var_random) / (var_fixed + var_random + var_resid)
  
  result <- rbind(
    marginal = c(mean = mean(R2_marginal), lower = quantile(R2_marginal, 0.025), upper = quantile(R2_marginal, 0.975)),
    conditional = c(mean = mean(R2_conditional), lower = quantile(R2_conditional, 0.025), upper = quantile(R2_conditional, 0.975))
  )
  
  print(result)  # <--- add this line for debugging
  return(result)
}

# Calculate and store results once
r2_full <- calc_marginal_conditional_R2(model_full, ipam, full_formula)
r2_Treatment <- calc_marginal_conditional_R2(mod_perc_Treatment, ipam, PercChangeCells ~ Treatment)
r2_symbiont <- calc_marginal_conditional_R2(mod_perc_symbiont, ipam, PercChangeCells ~ SymbiontTreatment)
r2_cross2 <- calc_marginal_conditional_R2(mod_perc_family, ipam, PercChangeCells ~ Cross)

# Check if they have the expected rownames
print(rownames(r2_full))      # Should be: "marginal" "conditional"
print(rownames(r2_Treatment)) # Same
print(rownames(r2_symbiont))  # Same
print(rownames(r2_cross2))    # Same

colnames(r2_full) <- c("mean", "lower", "upper")
colnames(r2_Treatment) <- c("mean", "lower", "upper")
colnames(r2_symbiont) <- c("mean", "lower", "upper")
colnames(r2_cross2) <- c("mean", "lower", "upper")

# Now build the dataframe using the stored results
results_df <- data.frame(
  Effect = c("Full Model", "Treatment", "SymbiontTreatment", "Cross"),

  Marginal_Mean = c(
    r2_full["marginal", "mean"],
    r2_Treatment["marginal", "mean"],
    r2_symbiont["marginal", "mean"],
    r2_cross2["marginal", "mean"]
  ),
  Marginal_Lower = c(
    r2_full["marginal", "lower"],
    r2_Treatment["marginal", "lower"],
    r2_symbiont["marginal", "lower"],
    r2_cross2["marginal", "lower"]
  ),
  Marginal_Upper = c(
    r2_full["marginal", "upper"],
    r2_Treatment["marginal", "upper"],
    r2_symbiont["marginal", "upper"],
    r2_cross2["marginal", "upper"]
  ),

  Conditional_Mean = c(
    r2_full["conditional", "mean"],
    r2_Treatment["conditional", "mean"],
    r2_symbiont["conditional", "mean"],
    r2_cross2["conditional", "mean"]
  ),
  Conditional_Lower = c(
    r2_full["conditional", "lower"],
    r2_Treatment["conditional", "lower"],
    r2_symbiont["conditional", "lower"],
    r2_cross2["conditional", "lower"]
  ),
  Conditional_Upper = c(
    r2_full["conditional", "upper"],
    r2_Treatment["conditional", "upper"],
    r2_symbiont["conditional", "upper"],
    r2_cross2["conditional", "upper"]
  )
)

print(results_df)


# Calculate relative contributions based on Marginal R² Mean
results_df$Relative_Contribution <- results_df$Marginal_Mean / results_df$Marginal_Mean[results_df$Effect == "Full Model"]
results_df$Relative_Contribution_Percent <- round(100 * results_df$Relative_Contribution, 1)

# Display selected columns, including Conditional R²
summary_df <- results_df[, c("Effect", 
                             "Marginal_Mean", 
                             "Conditional_Mean", 
                             "Relative_Contribution_Percent")]

# Print
print(summary_df)
```

##ONLY SURVIVORS: Percentage of Larvae that Acquired Cells with Source Cross
```{r}
#Percentage with Cells ############################################

# Step 1: Get UniqueIDs present at Timepoint 22
ids_at_22 <- ipam %>%
  filter(Timepoint == 22) %>%
  pull(UniqueID) %>%
  unique()

# Step 2: Subset ipam to include only those UniqueIDs
ipam_subset <- ipam %>%
  filter(UniqueID %in% ids_at_22)

# Ensure factors are ordered
ipam_subset$Treatment <- factor(ipam_subset$Treatment, 
                                     levels = c("Ambient", "31", "35.5"))
ipam_subset$Cross <- factor(ipam_subset$Cross, 
                                     levels = c("CC", "WW"))
ipam_subset$SymbiontTreatment <- factor(ipam_subset$SymbiontTreatment, 
                                     levels = c("C", "D"))

#Remove 35.5 because larvae didn't survive
ipam_subset <- ipam_subset %>% 
  filter(Treatment != "35.5") %>%
  droplevels()

#check how many observations per group
table(ipam_subset$SymbiontTreatment, ipam_subset$Cross, ipam_subset$Treatment)

#set prior
prior <- list(
  R = list(V = 1, nu = 0.002),  # Residual variance (Gaussian default)
  G = list(
    G1 = list(V = 1, nu = 0.002)  # Random effect for Replicate
  )
)

#model
model_perc <- MCMCglmm(
  PercChangeCells ~ SymbiontTreatment * Cross * Treatment,
  random = ~ Replicate,
  data = ipam_subset,
  family = "gaussian",
  prior = prior,
  nitt = 50000,
  burnin = 10000,
  thin = 20
)

summary(model_perc)

#Check chain convergence and mixing
library(coda)
mcmc_obj <- as.mcmc(model_perc$Sol)
plot(mcmc_obj)              # Trace and density plots
autocorr.diag(mcmc_obj)     # Autocorrelation
effectiveSize(mcmc_obj)     # Effective sample size

newdat_perc2 <- expand.grid(
  SymbiontTreatment = levels(ipam_subset$SymbiontTreatment),
  Cross = levels(ipam_subset$Cross),
  Treatment = levels(ipam_subset$Treatment)  
)

newdat_perc2$SymbiontTreatment <- factor(newdat_perc2$SymbiontTreatment, levels = levels(ipam_subset$SymbiontTreatment))
newdat_perc2$Cross <- factor(newdat_perc2$Cross, levels = levels(ipam_subset$Cross))
newdat_perc2$Treatment <- factor(newdat_perc2$Treatment, levels = levels(ipam_subset$Treatment))

lapply(newdat_perc2[, c("SymbiontTreatment", "Cross", "Treatment")], function(x) length(unique(x)))


X_full_subset <- model.matrix(~ SymbiontTreatment * Cross * Treatment, data = newdat_perc2)
X_subset <- X_full_subset[, colnames(model_perc$Sol), drop = FALSE]

pred_matrix_subset <- X_subset %*% t(model_perc$Sol)
newdat_perc2$pred_mean <- rowMeans(pred_matrix_subset)
newdat_perc2$lower <- apply(pred_matrix_subset, 1, quantile, probs = 0.025)
newdat_perc2$upper <- apply(pred_matrix_subset, 1, quantile, probs = 0.975)
newdat_perc2$significant <- !(newdat_perc2$lower < 0 & newdat_perc2$upper > 0)
newdat_perc2$label_combined <- paste0(round(newdat_perc2$pred_mean, 2),
                                       ifelse(newdat_perc2$significant, "*", ""))

ggplot(newdat_perc2, aes(x = Treatment, y = Cross, fill = pred_mean)) +
  geom_tile(color = "white") +
  geom_text(aes(label = label_combined), color = "black", size = 4) +
  facet_wrap(~ SymbiontTreatment) +
  scale_fill_viridis_c(name = "Predicted cell change %") +
  theme_minimal() +
  labs(title = "Predicted Change in Cell Density (No 35.5)",
       x = "Treatment", y = "Host Genotype")


#############################
### Modeling variables separate for each health metric to get relative contributions ###
#PercChangeCells ~ SymbiontTreatment * Cross * Treatment

# Load MCMCglmm if not already loaded
library(MCMCglmm)

# Your prior (make sure it's defined appropriately)
# Example placeholder:
prior <- list(R = list(V = 1, nu = 0.002), G = list(G1 = list(V = 1, nu = 0.002)))

# Full model formula
full_formula <- PercChangeCells ~ SymbiontTreatment * Cross * Treatment

# Fit the full model
model_full <- MCMCglmm(full_formula,
  random = ~ Replicate,
  data = ipam_subset,
  family = "gaussian",
  prior = prior,
  nitt = 50000,
  burnin = 10000,
  thin = 20
)

# Fit single fixed effect models
mod_perc_Treatment <- MCMCglmm(PercChangeCells ~ Treatment, 
                          random = ~ Replicate , 
                          data = ipam_subset, 
                          family = "gaussian", 
                          prior = prior, 
                          nitt = 50000, 
                          burnin = 10000, 
                          thin = 20)

mod_perc_symbiont <- MCMCglmm(PercChangeCells ~ SymbiontTreatment, 
                         random = ~ Replicate , 
                         data = ipam_subset, 
                         family = "gaussian", 
                         prior = prior, 
                         nitt = 50000, 
                         burnin = 10000, 
                         thin = 20)

mod_perc_family <- MCMCglmm(PercChangeCells ~ Cross, 
                       random = ~ Replicate , 
                       data = ipam_subset, 
                       family = "gaussian", 
                       prior = prior, 
                       nitt = 50000, 
                       burnin = 10000, 
                       thin = 20)

# Helper function to calculate marginal R²
calc_marginal_R2 <- function(model, data, fixed_formula) {
  # Build model matrix for fixed effects (includes intercept)
  X <- model.matrix(fixed_formula, data = data)
  
  # Extract posterior samples of fixed effects
  Sol <- model$Sol
  
  # Identify which columns in Sol correspond to fixed effects (including intercept)
  fixed_effect_names <- colnames(Sol)
  
  # Align columns of X and Sol by name
  # Remove any columns in X not present in Sol (unlikely, but safe)
  cols_to_keep <- colnames(X) %in% fixed_effect_names
  X_sub <- X[, cols_to_keep, drop = FALSE]
  
  # Subset Sol to columns matching X_sub
  Sol_sub <- Sol[, colnames(X_sub), drop = FALSE]
  
  # Now dimensions should align for multiplication: X_sub (n x p), t(Sol_sub) (p x samples)
  
  if (ncol(X_sub) != ncol(Sol_sub)) {
    stop("Mismatch between fixed effect columns in design matrix and posterior samples.")
  }
  
  # Calculate linear predictor samples: each row = one observation,
  # each column = one MCMC iteration sample
  linpred_samples <- X_sub %*% t(Sol_sub)  # dimensions: nrow(X_sub) x nrow(Sol_sub)
  
  # Variance of predicted values for each MCMC iteration
  var_fixed <- apply(linpred_samples, 2, var)
  
  # Variance components for random effects and residual
  # Here, adjust grep pattern if you have multiple random effects or different names
  var_random <- rowSums(model$VCV[, grep("Replicate", colnames(model$VCV)), drop = FALSE])
  var_resid <- model$VCV[, "units"]
  
  # Marginal R² per iteration
  R2_marginal <- var_fixed / (var_fixed + var_random + var_resid)
  
  # Return mean and 95% credible interval
  c(
    mean = mean(R2_marginal),
    lower = quantile(R2_marginal, 0.025),
    upper = quantile(R2_marginal, 0.975)
  )
}

# Calculate marginal R2 for all models
r2_full <- calc_marginal_R2(model_full, ipam_subset, full_formula)
r2_Treatment <- calc_marginal_R2(mod_perc_Treatment, ipam_subset, PercChangeCells ~ Treatment)
r2_symbiont <- calc_marginal_R2(mod_perc_symbiont, ipam_subset, PercChangeCells ~ SymbiontTreatment)
r2_cross2 <- calc_marginal_R2(mod_perc_family, ipam_subset, PercChangeCells ~ Cross)

# Print results
cat("Marginal R² for full model (all fixed effects + interactions):\n")
print(r2_full)
cat("\nMarginal R² for Treatment only model:\n")
print(r2_Treatment)
cat("\nMarginal R² for SymbiontTreatment only model:\n")
print(r2_symbiont)
cat("\nMarginal R² for Cross only model:\n")
print(r2_cross2)


calc_marginal_conditional_R2 <- function(model, data, fixed_formula) {
  X <- model.matrix(fixed_formula, data = data)
  Sol <- model$Sol
  
  cols_to_keep <- colnames(X) %in% colnames(Sol)
  X_sub <- X[, cols_to_keep, drop = FALSE]
  Sol_sub <- Sol[, colnames(X_sub), drop = FALSE]
  
  if (ncol(X_sub) != ncol(Sol_sub)) stop("Mismatch in fixed effect columns.")
  
  linpred_samples <- X_sub %*% t(Sol_sub)
  var_fixed <- apply(linpred_samples, 2, var)
  
  var_random <- rowSums(model$VCV[, grep("Replicate", colnames(model$VCV)), drop = FALSE])
  var_resid <- model$VCV[, "units"]
  
  R2_marginal <- var_fixed / (var_fixed + var_random + var_resid)
  R2_conditional <- (var_fixed + var_random) / (var_fixed + var_random + var_resid)
  
  result <- rbind(
    marginal = c(mean = mean(R2_marginal), lower = quantile(R2_marginal, 0.025), upper = quantile(R2_marginal, 0.975)),
    conditional = c(mean = mean(R2_conditional), lower = quantile(R2_conditional, 0.025), upper = quantile(R2_conditional, 0.975))
  )
  
  print(result)  # <--- add this line for debugging
  return(result)
}


library(ggplot2)

# Calculate and store results once
r2_full <- calc_marginal_conditional_R2(model_full, ipam_subset, full_formula)
r2_Treatment <- calc_marginal_conditional_R2(mod_perc_Treatment, ipam_subset, PercChangeCells ~ Treatment)
r2_symbiont <- calc_marginal_conditional_R2(mod_perc_symbiont, ipam_subset, PercChangeCells ~ SymbiontTreatment)
r2_cross2 <- calc_marginal_conditional_R2(mod_perc_family, ipam_subset, PercChangeCells ~ Cross)

# Check if they have the expected rownames
print(rownames(r2_full))      # Should be: "marginal" "conditional"
print(rownames(r2_Treatment)) # Same
print(rownames(r2_symbiont))  # Same
print(rownames(r2_cross2))    # Same

colnames(r2_full) <- c("mean", "lower", "upper")
colnames(r2_Treatment) <- c("mean", "lower", "upper")
colnames(r2_symbiont) <- c("mean", "lower", "upper")
colnames(r2_cross2) <- c("mean", "lower", "upper")

# Now build the dataframe using the stored results
results_df <- data.frame(
  Effect = c("Full Model", "Treatment", "SymbiontTreatment", "Cross"),

  Marginal_Mean = c(
    r2_full["marginal", "mean"],
    r2_Treatment["marginal", "mean"],
    r2_symbiont["marginal", "mean"],
    r2_cross2["marginal", "mean"]
  ),
  Marginal_Lower = c(
    r2_full["marginal", "lower"],
    r2_Treatment["marginal", "lower"],
    r2_symbiont["marginal", "lower"],
    r2_cross2["marginal", "lower"]
  ),
  Marginal_Upper = c(
    r2_full["marginal", "upper"],
    r2_Treatment["marginal", "upper"],
    r2_symbiont["marginal", "upper"],
    r2_cross2["marginal", "upper"]
  ),

  Conditional_Mean = c(
    r2_full["conditional", "mean"],
    r2_Treatment["conditional", "mean"],
    r2_symbiont["conditional", "mean"],
    r2_cross2["conditional", "mean"]
  ),
  Conditional_Lower = c(
    r2_full["conditional", "lower"],
    r2_Treatment["conditional", "lower"],
    r2_symbiont["conditional", "lower"],
    r2_cross2["conditional", "lower"]
  ),
  Conditional_Upper = c(
    r2_full["conditional", "upper"],
    r2_Treatment["conditional", "upper"],
    r2_symbiont["conditional", "upper"],
    r2_cross2["conditional", "upper"]
  )
)

print(results_df)


# Calculate relative contributions based on Marginal R² Mean
results_df$Relative_Contribution <- results_df$Marginal_Mean / results_df$Marginal_Mean[results_df$Effect == "Full Model"]
results_df$Relative_Contribution_Percent <- round(100 * results_df$Relative_Contribution, 1)

# Display selected columns, including Conditional R²
summary_df <- results_df[, c("Effect", 
                             "Marginal_Mean", 
                             "Conditional_Mean", 
                             "Relative_Contribution_Percent")]

# Print
print(summary_df)

##########
# Pairwise comparisons for survivors (Percent Change)
##########

# Create new data frame of combinations
newdat <- expand.grid(
  SymbiontTreatment = levels(ipam_subset$SymbiontTreatment),
  Cross = levels(ipam_subset$Cross),
  Treatment = levels(ipam_subset$Treatment)
)

# Ensure same factor levels as in model
newdat$SymbiontTreatment <- factor(newdat$SymbiontTreatment, levels = levels(ipam_subset$SymbiontTreatment))
newdat$Cross <- factor(newdat$Cross, levels = levels(ipam_subset$Cross))
newdat$Treatment <- factor(newdat$Treatment, levels = levels(ipam_subset$Treatment))

# For clarity in output
newdat$group <- with(newdat, paste(SymbiontTreatment, Cross, Treatment, sep = "_"))

# Design matrix must match the fixed effects structure in the full model
X <- model.matrix(~ SymbiontTreatment * Cross * Treatment, data = newdat)

# Match columns exactly
X <- X[, colnames(model_perc$Sol), drop = FALSE]

# Get posterior predictions
pred_matrix <- X %*% t(model_perc$Sol)

# All pairwise group combinations
group_combos <- combn(1:nrow(newdat), 2, simplify = FALSE)

# Compute posterior difference, 95% CI, and pMCMC
pairwise_results <- lapply(group_combos, function(idx) {
  i <- idx[1]
  j <- idx[2]
  diff <- pred_matrix[i, ] - pred_matrix[j, ]
  ci <- quantile(diff, probs = c(0.025, 0.975))
  pMCMC <- 2 * min(mean(diff > 0), mean(diff < 0))
  
  data.frame(
    group1 = newdat$group[i],
    group2 = newdat$group[j],
    mean_diff = mean(diff),
    lower = ci[1],
    upper = ci[2],
    pMCMC = pMCMC,
    significant = ci[1] > 0 | ci[2] < 0
  )
})

pairwise_df <- do.call(rbind, pairwise_results)

ggplot(pairwise_df, aes(group1, group2, fill = mean_diff)) +
  geom_tile() +
  geom_text(aes(label = ifelse(significant, "*", "")), color = "white") +
  scale_fill_viridis_c() +
  theme_minimal() +
  labs(title = "Pairwise Differences in log(Cell Density Change)",
       x = "Group 1", y = "Group 2")

# Add back-transformed columns and format them nicely
pairwise_summary <- pairwise_df %>%
  mutate(
    mean_diff_bt = exp(mean_diff) - 1,
    lower_bt = exp(lower) - 1,
    upper_bt = exp(upper) - 1,
    mean_diff_bt_fmt = formatC(mean_diff_bt, format = "e", digits = 2),
    lower_bt_fmt = formatC(lower_bt, format = "e", digits = 2),
    upper_bt_fmt = formatC(upper_bt, format = "e", digits = 2),
    significant_label = ifelse(significant, "*", "")
  ) %>%
  select(
    group1, group2,
    mean_diff, lower, upper,
    mean_diff_bt_fmt, lower_bt_fmt, upper_bt_fmt,
    pMCMC, significant_label
  ) %>%
  rename(
    `Group 1` = group1,
    `Group 2` = group2,
    `Mean Diff (log)` = mean_diff,
    `Lower 95% CI (log)` = lower,
    `Upper 95% CI (log)` = upper,
    `Mean Diff (back-transformed)` = mean_diff_bt_fmt,
    `Lower 95% CI (back-transformed)` = lower_bt_fmt,
    `Upper 95% CI (back-transformed)` = upper_bt_fmt,
    `pMCMC` = pMCMC,
    `Significant` = significant_label
  )

write.csv(pairwise_summary, "C:/Users/jc980786/OneDrive - James Cook University/GitHub/Larval.Infect.Exp/figures/pairwise_summary_table_perc_with_cells.csv", row.names = FALSE)

###############################################################
# Now with just Treatment and Cross

# Fit the model
model_tc <- MCMCglmm(
  PercChangeCells ~ Treatment * Cross,
  random = ~ Replicate,
  data = ipam_subset,
  family = "gaussian",
  prior = prior,
  nitt = 50000,
  burnin = 10000,
  thin = 20
)

# New data grid for predictions
newdat_tc <- expand.grid(
  Treatment = levels(ipam_subset$Treatment),
  Cross = levels(ipam_subset$Cross)
)

newdat_tc$Treatment <- factor(newdat_tc$Treatment, levels = levels(ipam_subset$Treatment))
newdat_tc$Cross <- factor(newdat_tc$Cross, levels = levels(ipam_subset$Cross))

# Model matrix for fixed effects (match model columns)
X_tc <- model.matrix(~ Treatment * Cross, data = newdat_tc)

# Subset posterior samples for fixed effects
common_cols <- intersect(colnames(model_tc$Sol), colnames(X_tc))
X_tc_aligned <- X_tc[, common_cols, drop = FALSE]
Sol_tc <- model_tc$Sol[, common_cols, drop = FALSE]

# Calculate predicted values per MCMC iteration
pred_mat_tc <- X_tc_aligned %*% t(Sol_tc)  # rows = groups, cols = MCMC samples

# Calculate pairwise differences for all combinations
pairwise_diff_tc <- combn(nrow(newdat_tc), 2, function(i) {
  diff_samples <- pred_mat_tc[i[1], ] - pred_mat_tc[i[2], ]
  data.frame(
    group1 = paste(as.character(newdat_tc$Treatment[i[1]]), as.character(newdat_tc$Cross[i[1]]), sep = "_"),
    group2 = paste(as.character(newdat_tc$Treatment[i[2]]), as.character(newdat_tc$Cross[i[2]]), sep = "_"),
    mean_diff = mean(diff_samples),
    lower = quantile(diff_samples, 0.025),
    upper = quantile(diff_samples, 0.975),
    pMCMC = 2 * min(mean(diff_samples > 0), mean(diff_samples < 0))
  )
}, simplify = FALSE) %>% bind_rows()

# Add significance flag
pairwise_diff_tc <- pairwise_diff_tc %>%
  mutate(significant = (lower > 0 | upper < 0))

head(pairwise_diff_tc)

###############################################################
# Now with just Treatment and SymbiontTreatment
model_ts <- MCMCglmm(
  PercChangeCells ~ Treatment * SymbiontTreatment,
  random = ~ Replicate,
  data = ipam_subset,
  family = "gaussian",
  prior = prior,
  nitt = 50000,
  burnin = 10000,
  thin = 20
)

newdat_ts <- expand.grid(
  Treatment = levels(ipam_subset$Treatment),
  SymbiontTreatment = levels(ipam_subset$SymbiontTreatment)
)

newdat_ts$Treatment <- factor(newdat_ts$Treatment, levels = levels(ipam_subset$Treatment))
newdat_ts$SymbiontTreatment <- factor(newdat_ts$SymbiontTreatment, levels = levels(ipam_subset$SymbiontTreatment))

X_ts <- model.matrix(~ Treatment * SymbiontTreatment, data = newdat_ts)
common_cols <- intersect(colnames(model_ts$Sol), colnames(X_ts))
X_ts_aligned <- X_ts[, common_cols, drop = FALSE]
Sol_ts <- model_ts$Sol[, common_cols, drop = FALSE]

pred_mat_ts <- X_ts_aligned %*% t(Sol_ts) 

# Pairwise differences same approach as above
pairwise_diff_ts <- combn(nrow(newdat_ts), 2, function(i) {
  diff_samples <- pred_mat_ts[i[1], ] - pred_mat_ts[i[2], ]
  data.frame(
    group1 = paste(as.character(newdat_ts$Treatment[i[1]]), as.character(newdat_ts$SymbiontTreatment[i[1]]), sep = "_"),
    group2 = paste(as.character(newdat_ts$Treatment[i[2]]), as.character(newdat_ts$SymbiontTreatment[i[2]]), sep = "_"),
    mean_diff = mean(diff_samples),
    lower = quantile(diff_samples, 0.025),
    upper = quantile(diff_samples, 0.975),
    pMCMC = 2 * min(mean(diff_samples > 0), mean(diff_samples < 0))
  )
}, simplify = FALSE) %>% bind_rows()


pairwise_diff_ts <- pairwise_diff_ts %>%
  mutate(significant = (lower > 0 | upper < 0))

head(pairwise_diff_ts)


```
